<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sosyal Medya Platformu - Ana Sayfa</title>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTQiIGZpbGw9IiM0Mjg1RjQiLz4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxMiIgcj0iNCIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTE2IDI0QzE5IDI0IDIyIDIyIDIyIDE4SDEwQzEwIDIyIDEzIDI0IDE2IDI0WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==" type="image/svg+xml">    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script defer>
let socket; 
        
function joinChat() {
  const profileData = JSON.parse(sessionStorage.getItem('profileData'));
  const token = sessionStorage.getItem('jwt');
  
  if (profileData && token) {

    socket = io('http://localhost:5000', {
      auth: {
        token: token
      }
    });

    socket.on('connect', () => {
      console.log('Socket connected successfully');
      
      socket.emit('join', {
        room: 'general' 
      });
    
      setupTypingDetection();
      // Listen for online status confirmation
      socket.on('user:online_confirmed', (data) => {
        console.log('âœ… User online confirmed:', data);
      });
    });

    // ============ MESSAGE HANDLERS ============
    socket.on("chat:receive_private", (message) => {
      console.log("ðŸ“© New private message:", message);
      // You can update UI here, e.g. add message to chat window
      appendMessage(message.sender, message, false);
    });

    socket.on("chat:receive_group", (message) => {
      console.log("ðŸ“© New group message:", message);
      // You can update UI here, e.g. add message to chat window
      appendMessage(message.chat, message, false, true);
    });

    // ============ ONLINE STATUS HANDLERS ============
    socket.on("chat:user_online_status", (data) => {
      console.log("ðŸ“¡ Online status received:", data);
      const { userId, isOnline, connections, timestamp } = data;
      
      console.log(`User ${userId} is ${isOnline ? 'online' : 'offline'} (${connections} connections)`);
      
      // Update UI to reflect user's online status
      updateUserOnlineStatus(userId, isOnline);
    });

    socket.on("chat:user_status_changed", (data) => {
      console.log("ðŸ”„ Friend status changed:", data);
      const { userId, isOnline } = data;
      
      // This is for when friends come online/offline
      updateUserOnlineStatus(userId, isOnline);
      
      // You can also show notifications
      if (isOnline) {
        showNotification(`${getUserName(userId)} is now online`);
      } else {
        showNotification(`${getUserName(userId)} is now offline`);
      }
    });
    // ============ TYPING INDICATORS HANDLERS ============
    socket.on("chat:typing_indicator", (data) => {
        console.log("âŒ¨ï¸ Typing indicator:", data);
        const { chatId, user, chatType, isTyping } = data;

        if (isTyping) {
            showTypingIndicator(user, chatId, chatType);
        } else {
            console.log("Hiding typing indicator for user:", user, "in chat:", chatId, "of type:", chatType);
            hideTypingIndicator(user, chatId, chatType);
        }
    });
    socket.on("chat:typing_users_list", (data) => {
        console.log("ðŸ“ Current typing users:", data);
        updateTypingUsersList(data.chatId, data.typingUsers);
    });

    // ============ ERROR HANDLERS ============
    socket.on('chat:error', (error) => {
      console.error('Chat error:', error.message);
      showNotification(`Error: ${error.message}`, 'error');
    });

    socket.on('connect_error', (error) => {
      console.error('Connection error:', error.message);
      if (error.message.includes('Authentication')) {
        console.log('Please log in again');
        // Token expired veya invalid ise login sayfasÄ±na yÃ¶nlendir
        sessionStorage.removeItem('profileData');
        sessionStorage.removeItem('jwt');
        window.location.href = '/login';
      }
    });

    // Handle disconnection
    socket.on('disconnect', (reason) => {
      console.log('Socket disconnected:', reason);
      if (reason === 'io server disconnect') {
        // Server disconnected us, try to reconnect
        socket.connect();
      }
    });

  } else {
    console.log("Token is missing. Please log in first.");
    window.location.href = '/login';
  }
}

async function isFriendOnline(friendId) {
  console.log('ðŸ” Checking online status for friendId:', friendId);
  
  return new Promise((resolve, reject) => {
    // Add timeout for the response
    const timeout = setTimeout(() => {
      reject('Timeout: No response from server');
    }, 5000);

    // Emit the event - note the parameter name should be 'userId' not 'friendId'
    socket.emit('chat:is_online', { userId: friendId });

    // Listen for the response (since we're not using callbacks, we listen for the event)
    const handleResponse = (data) => {
      if (data.userId === friendId) {
        clearTimeout(timeout);
        socket.off('chat:user_online_status', handleResponse);
        console.log(`âœ… Online status for ${friendId}:`, data.isOnline);
        resolve(data.isOnline);
      }
    };

    socket.on('chat:user_online_status', handleResponse);
  });
}

async function checkFriendsOnlineStatus(friends) {
  console.log('ðŸ” Checking online status for friends:', friends.map(f => f._id));
  
  const results = [];
  
  for (const friend of friends) {
    try {
      const isOnline = await isFriendOnline(friend._id);
      results.push({
        ...friend,
        isOnline: isOnline,
        lastChecked: new Date().toISOString()
      });
      console.log(`âœ… Online status for ${friend.name} (${friend._id}):`, isOnline);
    } catch (error) {
      console.error(`âŒ Failed to check online status for ${friend.name}:`, error);
      results.push({
        ...friend,
        isOnline: null, // null indicates error
        lastChecked: new Date().toISOString(),
        error: error.message
      });
    }
  }
  
  return results;
}

function updateUserOnlineStatus(userId, isOnline) {
  const currentRecipient = sessionStorage.getItem('recipient') ? sessionStorage.getItem('recipient') : null;
  const userStatusElem = document.getElementById(`chat-user-status`);
  const userElem = document.getElementById(`user-${userId}`);

  let userImageElem = null;
  if (userElem) {
    userImageElem = userElem.querySelector('.friend-profile-image');
  }

  if (userStatusElem && userId === currentRecipient) {
    userStatusElem.style.display = 'flex';
    userStatusElem.textContent = isOnline ? 'Online' : 'Offline';
    userStatusElem.style.color = isOnline ? '#43e97b' : '#bfc9d1';
  }

  if (userImageElem) {
    userImageElem.style.borderColor = isOnline ? '#43e97b' : '#00bcd4';
  }
}

function checkUsersOnlineStatus(userIds) {
  userIds.forEach(userId => {
    socket.emit('chat:is_online', { userId: userId });
  });
}

async function displayFriendStatus(friendId) {
  try {
    const isOnline = await isFriendOnline(friendId);
    console.log(`Friend ${friendId} is ${isOnline ? 'online' : 'offline'}`);
    updateUserOnlineStatus(friendId, isOnline);
    return isOnline;
  } catch (error) {
    console.error('Error checking friend status:', error);
    updateUserOnlineStatus(friendId, false); // Assume offline on error
    return false;
  }
}

function showNotification(message, type = 'info') {
  // Implement your notification system
  console.log(`ðŸ”” ${type.toUpperCase()}: ${message}`);
}

function getUserName(userId) {
  // Implement getting user name from your data
  return `User ${userId}`;
}
function sendMessage() {
  const clickedElementType = sessionStorage.getItem('clickedElementType');
  const messageInput = document.getElementById('message-input');
  const recipient = sessionStorage.getItem('recipient');
  const message = messageInput.value.trim();
  if (clickedElementType === 'friend') { 
  if (recipient && message) {
    socket.emit('chat:send_private', { 
      recipient: recipient, 
      content: message,
      messageType: 'text' // or MESSAGE_TYPES.TEXT if you have that constant defined
    }, (response) => {
      if (response && response.error) {
        console.error('Failed to send message:', response.message);
        // Handle error (show user notification, etc.)
      } 
    });
      console.log('Message sent successfully');
      // Optionally append the message to the UI immediately for instant feedback
      appendMessage(recipient, { 
        from: 'Me', 
        content: message, 
        messageType: 'text',
        timestamp: new Date()
      }, true);
    messageInput.value = '';
  }
} else if (clickedElementType === 'group') {
  socket.emit('chat:send_group', { 
    groupId: recipient, // Assuming you store current group ID
    content: message,
    messageType: 'text' // or MESSAGE_TYPES.TEXT if you have that constant defined
  }, (response) => {
      if (response && response.error) {
          console.error('Failed to send message:', response.message);
          // Handle error (show user notification, etc.)
        } 
      });
      console.log('Group message sent successfully');
      // Optionally append the message to the UI immediately for instant feedback
      appendMessage(recipient, { 
        from: 'Me', 
        content: message, 
        messageType: 'text',
        timestamp: new Date()
      }, true);
    
      messageInput.value = '';
} else {
    console.error('No chat selected');
    // Show error to user
}
}
                
function appendMessage(chatUser, messageData, isMyMessage, isGroup = false) {
  const chatBox = document.getElementById(`chatbox-${chatUser}`);
  
  if (!chatBox) {
    console.error(`Chatbox : chatbox-${chatUser}`);
    return;
  }
  if (!isMyMessage && document.getElementById(`message-${messageData._id}`)) {
    console.log('Message already exists in the chat box');
    return; 
  }
  let friend = { name: 'Unknown' };

  if (!isMyMessage && !isGroup) {
    const chatData = JSON.parse(sessionStorage.getItem('chatData'));
    friend = chatData.friends.find(f => f._id === chatUser);
  } else if (!isMyMessage && isGroup) {
    const chatData = JSON.parse(sessionStorage.getItem('chatData'));
    friend = chatData.friends.find(f => f._id === messageData.sender);
  }
  const updatedMessageData = { ...messageData, isRead: true };

  const messageElement = document.createElement('div');
  messageElement.id = `message-${updatedMessageData._id}`;
  messageElement.classList.add(isMyMessage ? 'my-message' : 'other-message');

  const strongElement = document.createElement('strong');
  strongElement.className = isMyMessage ? 'my-message-name' : 'other-message-name';
  if (isGroup && !isMyMessage) {
    strongElement.textContent = `${friend.email}`;
  } else if (!isGroup && !isMyMessage) {
    strongElement.textContent = `${friend.name}`;
  } else {
    strongElement.textContent = 'Me';
  }

  const messageText = document.createElement('p');
  messageText.appendChild(strongElement);
  messageText.appendChild(document.createTextNode(` ${updatedMessageData.content}`));

  messageElement.appendChild(messageText);
  chatBox.appendChild(messageElement);
  
  chatBox.scrollTop = chatBox.scrollHeight; 
  const recipient = sessionStorage.getItem('recipient');
  if (!isMyMessage && recipient && recipient === chatUser) {
    socket.emit('chat:mark_read', { messageId: updatedMessageData.id }, (response) => {
      if (response && response.error) {
        console.error('Failed to mark message as read:', response.message);
      } else {
        console.log('Message marked as read');
      }
    });
    
  } else if (!isMyMessage) {
    const userChat = document.getElementById(`user-${chatUser}`);
    const groupChat = document.getElementById(`group-${chatUser}`);
    if (userChat) {
      let unreadCountElem = userChat.querySelector('.unread-count');
      if (!unreadCountElem) {
        unreadCountElem = document.createElement('div');
        unreadCountElem.className = 'unread-count';
        unreadCountElem.textContent = 0;
        userChat.appendChild(unreadCountElem);
      }

      let count = parseInt(unreadCountElem.textContent) || 0;
      count += 1;
      unreadCountElem.textContent = count;
    } else if (groupChat) {
      let unreadCountElem = groupChat.querySelector('.unread-count');
      if (!unreadCountElem) {
        unreadCountElem = document.createElement('div');
        unreadCountElem.className = 'unread-count';
        unreadCountElem.textContent = 0;
        groupChat.appendChild(unreadCountElem);
      }

      let count = parseInt(unreadCountElem.textContent) || 0;
      count += 1;
      unreadCountElem.textContent = count;
    }
  }
}

function joinGroupsToSockets(groups) {
  if (!Array.isArray(groups)) return;
  groups.forEach(group => {
    if (group && group._id) {
      socket.emit('join_group', group._id); 
      console.log(`Joined group_${group._id}`);
    }
  });
}

    </script>
    <style id="account" rel="stylesheet">
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #181818 60%, #23272f 100%);
    color: #e0e0e0;
    min-height: 100dvh;
}

.account-container {
    width: 100%;
    height: 98dvh;
    display: none;
    justify-content: center;
    align-items: center;
    position: relative;
    background: rgba(24, 24, 24, 0.98);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.10); /* softer shadow */
}
.back-button {
    position: absolute;
    left: 16px;
    top: 16px;
    background: linear-gradient(135deg, #1E90FF, #00eaff 80%);
    color: white; 
    border: none; 
    padding: 10px 28px; 
    font-size: 17px; 
    border-radius: 8px; 
    cursor: pointer; 
    transition: background 0.3s, transform 0.2s;
    box-shadow: 0 1px 4px rgba(0,188,212,0.06); /* softer shadow */
    font-weight: 600;
    z-index: 2;
}

.back-button:hover {
    background: linear-gradient(135deg, #0056b3, #00eaff 90%);
    transform: scale(1.06) translateY(-2px);
}

.profile-wrapper {
    width: 100%;
    padding: 0px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.profile-card {
    background: rgba(31,31,31,0.98);
    border-radius: 18px;
    overflow: hidden;
    text-align: center;
    padding: 38px 36px 32px 36px;
    max-width: 420px;
    width: 100%;
    margin: 0 auto;
    position: relative;
}

.profile-header {
    margin-bottom: 30px;
}

.profile-image {
    width: 160px;
    height: 160px;
    border-radius: 50%;
    object-fit: cover;
    border: 5px solid #1E90FF;
    box-shadow: 0 2px 6px rgba(0,188,212,0.06); /* softer shadow */
    background: #23272f;
    transition: border-color 0.3s, box-shadow 0.3s;
}
.profile-image:hover {
    border-color: #00eaff;
    box-shadow: 0 4px 12px rgba(0,234,255,0.09); /* softer shadow */
}

.profile-name {
    font-size: 2.2rem;
    color: #ffffff;
    margin-top: 22px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.profile-email {
    font-size: 1.13rem;
    color: #bfc9d1;
    margin-top: 4px;
    word-break: break-all;
}

.profile-details {
    margin-top: 32px;
    text-align: center;
}

.profile-detail {
    margin-bottom: 22px;
}

.profile-detail h3 {
    font-size: 1.18rem;
    color: #00eaff;
    margin-bottom: 8px;
    font-weight: 600;
    letter-spacing: 0.2px;
}

.profile-detail p {
    font-size: 1.08rem;
    color: #e0e0e0;
    background: #23272f;
    border-radius: 7px;
    padding: 10px 14px;
    display: inline-block;
    min-width: 120px;
    word-break: break-word;
}

.profile-edit-button {
    background: linear-gradient(135deg, #1E90FF, #00eaff 80%);
    color: white;
    padding: 15px 38px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    font-size: 1.18rem;
    margin-top: 18px;
    font-weight: 600;
    box-shadow: 0 1px 4px rgba(0,188,212,0.06); /* softer shadow */
}

.profile-edit-button:hover {
    background: linear-gradient(135deg, #0056b3, #00eaff 90%);
    transform: scale(1.05) translateY(-2px);
}

.profile-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100dvh;
    background: rgba(0, 0, 0, 0.65);
    justify-content: center;
    align-items: center;
    z-index: 999;
}

.modal-content {
    background: #23272f;
    border-radius: 16px;
    padding: 36px 32px 28px 32px;
    width: 95%;
    max-width: 420px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,188,212,0.06); /* softer shadow */
    position: relative;
    animation: fadeInModal 0.25s;
}
@keyframes fadeInModal {
    from { opacity: 0; transform: scale(0.96);}
    to { opacity: 1; transform: scale(1);}
}

.modal-content h2 {
    margin-bottom: 28px;
    color: #00eaff;
    font-size: 1.45rem;
    font-weight: 700;
}

.modal-content label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #e0e0e0;
    font-size: 1.08rem;
    text-align: left;
}

.modal-content input, 
.modal-content textarea {
    width: 100%;
    padding: 12px;
    margin-bottom: 18px;
    border: 1.5px solid #444;
    border-radius: 8px;
    font-size: 1rem;
    background-color: #20232a;
    color: #e0e0e0;
    transition: border-color 0.2s;
}
.modal-content input:focus, 
.modal-content textarea:focus {
    border-color: #00eaff;
    outline: none;
}
.modal-content textarea {
    min-height: 60px;
    resize: vertical;
}

.modal-buttons {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    margin-top: 10px;
}

.save-button {
    background: linear-gradient(135deg, #1E90FF, #00eaff 80%);
    color: white;
    border: none;
    padding: 10px 22px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.08rem;
    font-weight: 600;
    transition: background 0.3s, transform 0.2s;
    box-shadow: 0 1px 4px rgba(0,188,212,0.06); /* softer shadow */
}

.save-button:hover {
    background: linear-gradient(135deg, #0056b3, #00eaff 90%);
    transform: scale(1.05);
}

.cancel-button {
    background: #444;
    color: #e0e0e0;
    border: none;
    padding: 10px 22px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.08rem;
    font-weight: 600;
    transition: background 0.2s;
}

.cancel-button:hover {
    background: #555;
}

.image-preview {
    max-width: 120px;
    margin-top: 10px;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,188,212,0.06); /* softer shadow */
    border: 2px solid #00eaff;
    background: #23272f;
}

/* Responsive Design */
@media (max-width: 600px) {
    .profile-card, .modal-content {
        padding: 18px 6vw 18px 6vw;
        max-width: 98vw;
    }
    .profile-image {
        width: 110px;
        height: 110px;
    }
    .profile-name {
        font-size: 1.3rem;
    }
    .profile-detail p {
        font-size: 0.98rem;
    }
}
    </style>
    <style id="landing-general-styles" rel="stylesheet">
.Landing-page {
    width: 100vw;
    height: 100vh;
    min-height: 100dvh;
    display: none;
    flex-direction: column;
    background: linear-gradient(135deg, #181818 60%, #23272f 100%);
}

.main-container {
    display: flex;
    width: 100vw;
    height: 100vh;
    min-height: 100dvh;
    flex-grow: 1;
    background: transparent;
}        
    </style>
    <style id="landing-left-container" rel="stylesheet">
.left-container {
    width: 20vw;
    min-width: 240px;
    height: 100vh;
    background: rgba(28, 32, 38, 0.98);
    border-right: 1px solid #23272f;
    border-top: 0px solid #23272f;
    border-bottom: 1px solid #23272f;
    box-shadow: 0 6px 18px rgba(0,0,0,0.22);
    border-radius: 0px 0 0 6px;
    display: flex;
    flex-direction: column;
}

.lower-component {
    display: flex;
    flex-direction: column;
    z-index: 1000;
    max-height: calc(100vh - 200px);
    background: transparent;
    padding: 2px;
    border-right: 1px solid #333;
    overflow-y: auto;
    box-shadow: 0 4px 8px rgba(0,0,0,0.09);
    position: relative;
}

.top-component-top {
    display: flex;
    background: transparent;
    padding: 14px 14px 0 14px;
    border-right: 1px solid #333;
    overflow-y: auto;
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    z-index: 1000;
}

.top-component-lower {
    display: flex;
    background: transparent;
    flex-direction: column;
    padding: 0 14px 14px 14px;
    border-right: 1px solid #333;
    overflow-y: auto;
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    z-index: 1000;
}

.profile-btn {
    display: flex;
    align-items: center;
    cursor: pointer;
    margin-right: 12px;
    position: absolute;
    left: 10px;
    bottom: 12px;
    z-index: 10;
}

.profile-btn img {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    transition: 0.3s ease-out, transform 0.2s ease;
    border: 2px solid #00bcd4;
    box-shadow: 0 2px 8px rgba(0,0,0,0.13);
}

.profile-btn img:hover {
    transform: scale(1.18) rotate(-2deg);
    border-color: #43e97b;
}

.settings-btn {
    background-color: transparent;
    color: #bfc9d1;
    border: none;
    cursor: pointer;
    transition: 0.3s, transform 0.2s;
    position: absolute;
    left: 15px;
    bottom: 66px;
    z-index: 10;
}

.settings-btn:hover {
    color: #43e97b;
    transform: scale(1.18) rotate(8deg);
}

.settings-btn i {
    font-size: 36px;
}

.add-thing-btn {
    padding: 13px 0;
    margin: 12px 6px;
    background: linear-gradient(135deg, #00bcd4, #43e97b 80%);
    color: #fff;
    font-size: 17px;
    font-weight: 600;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s, box-shadow 0.2s;
    width: 50%;
    box-shadow: 0 4px 12px rgba(67, 233, 123, 0.08);
    letter-spacing: 0.5px;
}

.add-thing-btn:hover {
    background: linear-gradient(135deg, #43e97b, #00eaff 90%);
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 8px 18px rgba(67, 233, 123, 0.13);
}

.add-thing-btn:active {
    transform: translateY(0) scale(1);
    box-shadow: 0 3px 6px rgba(67, 233, 123, 0.08);
}

.friend-profile-image {
    background-size: cover;
    background-position: center;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    margin-right: 12px;
    margin-bottom: 4px;
    margin-top: 4px;
    border: 2px solid #00bcd4;
    box-shadow: 0 2px 8px rgba(0,188,212,0.08);
}

.friend-name {
    margin-top: 0px;
    font-size: 17px;
    font-weight: 500;
    color: #e0e0e0;
    letter-spacing: 0.2px;
    display: block; 
    max-width: 14ch;
    white-space: nowrap;    
    overflow: hidden;
    text-overflow: ellipsis; 
}

.unread-count {
    background-color: #ff7043;
    color: white;
    font-size: 13px;
    font-weight: bold;
    padding: 3px 3px;
    border-radius: 12px;
    display: inline-block;
    min-width: 20px;
    text-align: center;
    position: absolute;
    top: 5px;
    right: 5px;
    box-shadow: 0 2px 6px rgba(255,112,67,0.13);
}

.user {
    padding: 0 6px;
    margin: 6px 4px;
    background: linear-gradient(90deg, #23272f 80%, #23272f00 100%);
    border-radius: 7px;
    display: flex;
    flex-direction: row;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
    position: relative;
    align-items: center;
    min-height: 56px;
}

.user:hover {
    background: linear-gradient(90deg, #2b2f38 80%, #23272f00 100%);
    transform: scale(1.04);
    box-shadow: 0 2px 8px rgba(0,188,212,0.07);
}

.user span {
    font-weight: bold;
    font-size: 16px;
    color: #fff;
}

.add-thing-container {
    display: none;
    margin-top: 15px;
    text-align: center;
    background: #23272f;
    border-radius: 8px;
    padding: 12px 0 8px 0;
    box-shadow: 0 2px 8px rgba(0,188,212,0.06);
}

.add-thing-container input {
    width: 80%;
    padding: 10px;
    background: #333;
    border: 1.5px solid #444;
    border-radius: 6px;
    color: #e0e0e0;
    outline: none;
    margin-bottom: 10px;
    font-size: 15px;
    transition: border-color 0.2s;
}

.add-thing-container textarea {
    width: 80%;
    padding: 10px;
    background: #333;
    border: 1.5px solid #444;
    border-radius: 6px;
    color: #e0e0e0;
    outline: none;
    margin-bottom: 10px;
    font-size: 15px;
    transition: border-color 0.2s;
    min-height: 60px;
    resize: vertical;
}   



.add-thing-container input:focus {
    border-color: #43e97b;
}

.add-thing-down-btn {
    padding: 6px 0;
    background: linear-gradient(135deg, #00bcd4, #43e97b 80%);
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s, box-shadow 0.2s;
    width: 50%;
    box-shadow: 0 4px 12px rgba(67, 233, 123, 0.08);
    letter-spacing: 0.5px;
}

.add-thing-down-btn:hover {
    background: linear-gradient(135deg, #43e97b, #00eaff 90%);
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 8px 18px rgba(67, 233, 123, 0.13);
}

.add-thing-down-btn:active {
    transform: translateY(0) scale(1);
    box-shadow: 0 3px 6px rgba(67, 233, 123, 0.08);
}
/* Detail Section - Match Landing Page Style */
.detail-section {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 96vw;
    max-width: 480px;
    max-height: 92vh;
    background: #23272f;
    border-radius: 14px;
    box-shadow: 0 8px 32px rgba(0, 188, 212, 0.13), 0 2px 8px rgba(0,0,0,0.18);
    z-index: 1000;
    overflow: hidden;
    display: none;
    color: #e0e0e0;
    animation: fadeInModal 0.25s;
}

.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 22px 14px 22px;
    background: linear-gradient(135deg, #181818 60%, #23272f 100%);
    border-bottom: 1.5px solid #23272f;
}

.detail-header h2 {
    margin: 0;
    font-size: 1.35rem;
    color: #7ad1e6;
    font-weight: 700;
    letter-spacing: 0.2px;
}

.close-detail {
    background: none;
    border: none;
    font-size: 1.3rem;
    cursor: pointer;
    color: #bfc9d1;
    padding: 5px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s;
}
.close-detail:hover {
    background: #23272f;
    color: #43e97b;
}

.detail-content {
    padding: 22px 20px 18px 20px;
    overflow-y: auto;
    max-height: calc(92vh - 70px);
}

.detail-avatar {
    width: 82px;
    height: 82px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00bcd4, #43e97b 80%);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.1rem;
    font-weight: bold;
    margin: 0 auto 15px auto;
    box-shadow: 0 2px 8px rgba(67,233,123,0.09);
}

.detail-name {
    font-size: 1.35rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 5px;
    color: #e0e0e0;
    letter-spacing: 0.2px;
}

.detail-info {
    text-align: center;
    color: #43e97b;
    margin-bottom: 18px;
    font-size: 1.05rem;
}

.detail-content h3 {
    color: #7ad1e6;
    margin: 18px 0 8px 0;
    font-size: 1.08rem;
    font-weight: 600;
    letter-spacing: 0.2px;
}

.contact-info p {
    margin: 7px 0;
    color: #bfc9d1;
    font-size: 0.98rem;
}

.recent-activity,
.member-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.activity-item,
.member-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 9px 0;
    border-bottom: 1px solid #23272f;
}

.activity-item:last-child,
.member-item:last-child {
    border-bottom: none;
}

.activity-text {
    color: #e0e0e0;
    flex: 1;
    font-size: 0.98rem;
}

.activity-time {
    color: #bfc9d1;
    font-size: 0.92rem;
    margin-left: 12px;
}

.member-item {
    display: flex;
    align-items: center;
    gap: 12px;
}

.member-avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: linear-gradient(135deg, #43e97b, #00eaff 80%);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1rem;
    box-shadow: 0 2px 8px rgba(67,233,123,0.09);
}

.member-info {
    flex: 1;
}

.member-name {
    font-weight: 500;
    color: #e0e0e0;
    font-size: 1rem;
}

.member-role {
    font-size: 0.93rem;
    color: #43e97b;
}

/* Backdrop overlay */
.detail-section::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(24, 24, 24, 0.70);
    z-index: -1;
}

/* Add Member Section */
.add-member-container {
    margin-top: 14px;
    padding: 14px;
    background: #1d1f25;
    border: 1px solid #23272f;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 188, 212, 0.08);
}

.add-member-container form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.add-member-container input,
.add-member-container select {
    background: #23272f;
    border: 1px solid #2f333d;
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 0.95rem;
    color: #e0e0e0;
    outline: none;
    transition: border 0.2s, box-shadow 0.2s;
}

.add-member-container input:focus,
.add-member-container select:focus {
    border-color: #43e97b;
    box-shadow: 0 0 0 2px rgba(67, 233, 123, 0.25);
}

.add-member-container button {
    background: linear-gradient(135deg, #00bcd4, #43e97b);
    border: none;
    border-radius: 8px;
    padding: 10px;
    font-size: 0.98rem;
    font-weight: 600;
    color: #fff;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 3px 10px rgba(0, 188, 212, 0.25);
}

.add-member-container button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(67, 233, 123, 0.35);
}

/* Responsive design */
@media (max-width: 768px) {
    .left-container {
        width: 0;
        min-width: 0px;
        position: fixed; /* or absolute */
        left: 0;
        top: 0;
        display: flex;
        flex-direction: column;
        z-index: 10; /* keeps it on top if needed */
        overflow: hidden; /* hides inner content when closed */
        transition: transform 0.3s ease, width 0.3s ease;
    }
    .detail-content {
        padding: 13px 7vw 13px 7vw;
    }
    .detail-header {
        padding: 13px 7vw 10px 7vw;
    }
}

@media (max-width: 480px) {
    .detail-section {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }
    .detail-content {
        max-height: calc(100vh - 70px);
        padding: 10px 2vw 10px 2vw;
    }
}        
    </style>
    <style id="landing-chat-container" rel="stylesheet">
.chat-container {
    width: 80vw;
    min-width: 0;
    background: linear-gradient(135deg, #181818 80%, #23272f 100%);
    border-left: 1.5px solid #23272f;
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100vh;
    justify-content: flex-end;
    flex-grow: 1;
    border-radius: 0 8px 8px 0;
}

.toggle-btn {
    z-index: 1000;
    position: absolute;
    top: 0px;
    left: -4px;
    background: rgba(28, 32, 38, 0.98);
    color: white;
    border-left: 1px solid #23272f;
    border-top: none;
    border-radius: 0 0 8px 0;
    padding: 26px 5px; 
    font-size: 14px; 
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease; 
    display: none;
    align-items: center;
    justify-content: center; 
}

.toggle-btn.rotated i {
    transform: rotate(180deg); 
}

.open-tggl {
    width: 75vw; 
}

.close-tggl {
    width: 25vw;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(28, 32, 38, 0.98);
    padding: 12px 20px;
    border-bottom: 1.5px solid #23272f;
    box-shadow: 0 2px 12px rgba(0,0,0,0.18);
    position: absolute;
    top: 0;
    width: calc(100% - 1.5px);
    height: 64px;
    box-sizing: border-box;
}

.chat-user-info {
    display: flex;
    align-items: center;
    gap: 14px;
}

.user-avatar {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #00bcd4;
    box-shadow: 0 2px 8px rgba(0,188,212,0.08);
    transition: 0.3s ease-out, transform 0.2s ease;
}

.user-avatar:hover {
    transform: scale(1.18) rotate(-2deg);
    border-color: #43e97b;
}

.chat-user-details h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #e0e0e0;
    letter-spacing: 0.2px;
}

.user-status {
    display: none;
    font-size: 13px;
    color: #bfc9d1;
    margin-top: 2px;
}

.chat-actions {
    display: flex;
    gap: 8px;
}

.chat-action-btn {
    background: transparent;
    color: #bfc9d1;
    border: none;
    padding: 10px;
    border-radius: 50%;
    cursor: pointer;
    transition: 0.3s, transform 0.2s;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
}

.chat-action-btn:hover {
    color: #43e97b;
    transform: scale(1.18) rotate(8deg);
    background: rgba(67, 233, 123, 0.1);
}

.chat-action-btn:nth-child(1):hover {
    background: linear-gradient(135deg, rgba(0, 188, 212, 0.1), rgba(67, 233, 123, 0.1));
}

.chat-action-btn:nth-child(2):hover {
    background: linear-gradient(135deg, rgba(67, 233, 123, 0.1), rgba(0, 234, 255, 0.1));
}

.chat-action-btn:nth-child(3):hover {
    background: linear-gradient(135deg, rgba(0, 234, 255, 0.1), rgba(0, 188, 212, 0.1));
}

.chat-box {
    margin-top: 0;
    background: rgba(30, 27, 27, 0.98);
    border-radius: 12px;
    padding: 18px 18px 8px 18px;
    overflow-y: auto;
    display: block;
    flex-direction: column;
    flex-grow: 1;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    max-width: 100%;
    min-height: 320px;
    margin: 8px 5px;
    height: 100%;
}

#message {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 8px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    list-style-type: none;
}

.chat-message {
    margin: 10px 0;
    padding: 10px;
    border-radius: 10px;
    color: #e0e0e0;
}

.my-message {
    background: linear-gradient(135deg, #43e97b 80%, #80e1a0 100%);
    color: white;
    margin-left: auto;
    word-wrap: break-word;
    overflow-wrap: break-word;
    width: fit-content;
    max-width: 35vw;
    min-width: 18ch;
    padding: 14px 16px 12px 16px;
    border-radius: 12px;
    margin-top: 7px;
    margin-bottom: 7px;
    position: relative;
    padding-top: 22px;
    box-shadow: 0 2px 8px rgba(67,233,123,0.09);
}
.my-message::after {
    content: "";
    position: absolute;
    top: 0;
    right: -8px;
    width: 0;
    height: 0;
    border-left: 16px solid #43e97b;
    border-bottom: 18px solid transparent;
}

.my-message-name {
    position: absolute;
    left: 12px;
    top: 5px;
    font-size: 11px;
    color: #eafff7;
    font-weight: bold;
    opacity: 0.85;
}

.other-message {
    background: linear-gradient(135deg, #23272f 80%, #363739 100%);
    color: #e0e0e0;
    margin-right: auto;
    word-wrap: break-word;
    overflow-wrap: break-word;
    width: fit-content;
    min-width: 18ch;
    max-width: 35vw;
    padding: 14px 16px 12px 16px;
    border-radius: 12px;
    margin-top: 7px;
    margin-bottom: 7px;
    position: relative;
    padding-top: 22px;
    box-shadow: 0 2px 8px rgba(33,150,243,0.07);
}

.other-message::after {
    content: "";
    position: absolute;
    top: 0;
    left: -8px;
    width: 0;
    height: 0;
    border-right: 16px solid #23272f;
    border-bottom: 18px solid transparent;
}

.other-message-name {
    position: absolute;
    left: 12px;
    top: 5px;
    font-size: 11px;
    color: #00bcd4;
    font-weight: bold;
    opacity: 0.85;
}

.input-container {
    display: flex;
    margin: 3px 5px 8px 5px;
    background: #23272f;
    border-radius: 20px;
    padding: 0px 0px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    align-items: center;
}

.input-container input {
    width: 100%;
    padding: 12px 16px;
    background: #20232a;
    border: none;
    border-radius: 20px;
    color: #e0e0e0;
    outline: none;
    font-size: 16px;
    margin-right: 8px;
    transition: background 0.2s;
}

.input-container input:focus {
    background: #23272f;
}

.input-container button {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, #00bcd4, #43e97b 80%);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    color: white;
    margin-left: 2px;
    outline: none;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, transform 0.15s;
    box-shadow: 0 2px 8px rgba(67,233,123,0.09);
}

.input-container button:hover {
    background: linear-gradient(135deg, #43e97b, #00eaff 90%);
    transform: scale(1.08) rotate(-8deg);
}

/* Enhanced Typing Indicator */
.typing-indicator {
    padding: 0px 0px;
    font-style: italic;
    color: #43e97b;
    display: none;
    align-items: center;
    background: transparent;
    border-radius: 18px;
    max-width: fit-content;
    animation: slideInUp 0.3s ease-out;
}

/* Inline styling for the animated "typing" word */
#typing-indicator .typing-word {
    display: flex;
    gap: 2px;
    margin-bottom: 6px;
    align-items: flex-end;
    font-weight: 700;
    color: #43e97b;
    font-size: 14px;
    letter-spacing: 1px;
}

#typing-indicator .typing-letter {
    display: inline-block;
    opacity: 0.25;
    transform: translateY(3px) scale(0.96);
    animation: letterPop 1.2s infinite ease-in-out;
}

/* staggered delays to mimic dot-typing rhythm */
#typing-indicator .typing-letter:nth-child(1){ animation-delay: 0s; }
#typing-indicator .typing-letter:nth-child(2){ animation-delay: 0.12s; }
#typing-indicator .typing-letter:nth-child(3){ animation-delay: 0.24s; }
#typing-indicator .typing-letter:nth-child(4){ animation-delay: 0.36s; }
#typing-indicator .typing-letter:nth-child(5){ animation-delay: 0.48s; }
#typing-indicator .typing-letter:nth-child(6){ animation-delay: 0.60s; }

@keyframes letterPop {
    0%, 80%, 100% { opacity: 0.25; transform: translateY(6px) scale(0.96); }
    40% { opacity: 1; transform: translateY(0) scale(1.03); }
}

.typing-dots {
    display: flex;
    gap: 2px;
    align-items: flex-end;  /* Changed from center to flex-end */
}

.typing-dots span {
    width: 3px;
    height: 3px;
    padding-top: 2px;
    border-radius: 50%;
    background: linear-gradient(135deg, #43e97b 0%, #00eaff 100%);
    display: inline-block;
    animation: bubble-dance 1.4s infinite ease-in-out;
    transform-origin: center;
    font-size: 0;
}

.typing-dots span:nth-child(1) {
    animation-delay: 0s;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

.typing-indicator > span:last-child {
    font-size: 14px;
    color: #43e97b;
    font-weight: 500;
    margin-left: 4px;
}

/* Animations */
@keyframes bubble-dance {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
        background: linear-gradient(135deg, #43e97b 0%, #00eaff 50%);
    }
    40% {
        transform: scale(1.2);
        opacity: 1;
        background: linear-gradient(135deg, #00eaff 0%, #43e97b 100%);
    }
}

@keyframes slideInUp {
    0% {
        opacity: 0;
        transform: translateY(10px) scale(0.95);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes slideOutDown {
    0% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateY(10px) scale(0.95);
    }
}

.typing-indicator.visible {
    display: flex !important;
}

.typing-indicator.hiding {
    animation: slideOutDown 0.3s ease-in forwards;
}

/* Responsive */
@media (max-width: 768px) {
    .toggle-btn {
        display: flex; 
    }
    
    .typing-indicator {
        padding: 0 0;
        border-radius: 16px;
    }
    
    .typing-dots span {
        width: 4px;
        height: 4px;
    }
}     
    </style>
    <style id="auth" rel="stylesheet">
.login-page,
.sign-up-page,
.forget-password-page,
.forget-code-insert-page,
.code-insert-page,
.refresh-password-page {
    width: 100vw;
    height: 100vh;
    min-height: 100dvh;
    display: none;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #181818 60%, #23272f 100%);
    position: fixed;
    top: 0;
    left: 0;
    z-index: 100;
}

.registration-container {
    background: rgba(34, 39, 47, 0.98);
    padding: 36px 32px 28px 32px;
    box-shadow: 0 1px 4px rgba(0,188,212,0.13), 0 2px 8px rgba(0,0,0,0.18);
    border-radius: 18px;
    width: 100%;
    max-width: 410px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
    animation: fadeInModal 0.25s;
}

.registration-header {
    text-align: center;
    margin-bottom: 18px;
    color: #00eaff;
    font-size: 2.1em;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-shadow: 0 2px 8px rgba(0,188,212,0.09);
}

.registration-form {
    display: flex;
    flex-direction: column;
    width: 100%;
}

.input-field {
    width: 100%;
    padding: 13px 16px;
    margin-top: 10px;
    margin-bottom: 18px;
    border: 1.5px solid #444;
    border-radius: 8px;
    font-size: 1.07em;
    background-color: #23272f;
    color: #e0e0e0;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
}

.input-field:focus {
    border-color: #00eaff;
    outline: none;
    box-shadow: 0 0 0 2px #00eaff33;
}

.submit-button {
    width: 100%;
    padding: 13px;
    background: linear-gradient(135deg, #1E90FF, #00eaff 80%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.13em;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s, box-shadow 0.2s;
    margin-top: 4px;
    box-shadow: 0 2px 8px rgba(0,188,212,0.09);
}

.submit-button:hover {
    background: linear-gradient(135deg, #0056b3, #00eaff 90%);
    transform: scale(1.04) translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,188,212,0.13);
}

.form-link {
    display: block;
    text-align: center;
    margin-top: 13px;
    text-decoration: none;
    color: #bfc9d1;
    font-size: 0.98em;
    transition: color 0.2s;
}

.form-link:hover {
    color: #00eaff;
    text-decoration: underline;
}

.success-message {
    color: #32CD32;
    display: none;
    text-align: center;
    margin-bottom: 10px;
    font-weight: 600;
    letter-spacing: 0.2px;
}

.error-message {
    color: #FF4500;
    display: none;
    text-align: center;
    margin-bottom: 10px;
    font-weight: 600;
    letter-spacing: 0.2px;
}

.secret-section {
    display: none;
}

/* Show error/success when needed */
.error-message[style*="display: block"],
.success-message[style*="display: block"] {
    display: block !important;
}

/* Add a subtle divider between form and links */
.registration-form .form-link:first-of-type {
    margin-top: 18px;
    border-top: 1px solid #333;
    padding-top: 10px;
}

/* Responsive Design */
@media (max-width: 600px) {
    .registration-container {
        padding: 18px 6vw 18px 6vw;
        max-width: 98vw;
    }
    .registration-header {
        font-size: 1.4em;
    }
    .input-field {
        font-size: 0.98em;
    }
    .submit-button {
        font-size: 1em;
    }
}

@keyframes fadeInModal {
    from { opacity: 0; transform: scale(0.96);}
    to { opacity: 1; transform: scale(1);}
}        
    </style>
    <style id="main" rel="stylesheet">
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Arial, sans-serif;
    scroll-behavior: smooth;
}

body {
    background-color: #222;
    color: #e0e0e0;
}

.main-page {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    width: 100%;
}

.main-navbar {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 5%;
    background: #282828;
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    border-bottom: 1px solid #23272f;
}

.main-navbar.scrolled {
    background: #23272f;
    padding: 10px 5%;
}

.platform-logo h1 {
    font-size: 2em;
    font-weight: bold;
    color: #7ad1e6;
    letter-spacing: 1px;
    text-shadow: none;
    transition: color 0.3s;
}

.platform-logo h1:hover {
    color: #8fd6b7;
}

.navigation-links {
    display: flex;
    gap: 22px;
}

.navigation-links a {
    font-size: 1em;
    color: #e0e0e0;
    text-decoration: none;
    transition: all 0.2s;
    padding: 8px 14px;
    border-radius: 5px;
    font-weight: 500;
}

.navigation-links a:hover {
    color: #222;
    background: #b6e2f0;
    box-shadow: none;
}

.login-button {
    background: #7ad1e6;
    padding: 10px 22px;
    border-radius: 7px;
    font-weight: bold;
    cursor: pointer;
    color: #222;
    text-decoration: none;
    box-shadow: none;
    border: none;
    transition: background 0.2s;
}

.login-button:hover {
    background: #8fd6b7;
    transform: scale(1.03);
}

.hero-banner {
    width: 98%;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 80px 5% 60px 5%;
    margin-top: 70px;
    background: #23272f;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden;
}

.hero-content {
    width: 100%;
    position: relative;
    z-index: 1;
}

.hero-content h2 {
    font-size: 2em;
    color: #e0e0e0;
    margin-bottom: 14px;
    letter-spacing: 1px;
    text-shadow: none;
}

.hero-content p {
    font-size: 1.1em;
    color: #bfc9d1;
    margin-bottom: 20px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.primary-cta-button {
    display: inline-block;
    background: #7ad1e6;
    padding: 12px 28px;
    font-size: 1em;
    border-radius: 8px;
    transition: background 0.2s, transform 0.15s;
    text-decoration: none;
    color: #222;
    font-weight: bold;
    box-shadow: none;
    cursor: pointer;
}

.primary-cta-button:hover {
    background: #8fd6b7;
    transform: scale(1.03);
}

.secondary-cta-button {
    display: inline-block;
    background: transparent;
    padding: 12px 28px;
    font-size: 1em;
    border-radius: 8px;
    transition: all 0.2s;
    text-decoration: none;
    color: #7ad1e6;
    font-weight: bold;
    border: 2px solid #7ad1e6;
    margin-left: 12px;
}

.secondary-cta-button:hover {
    background: #7ad1e6;
    color: #222;
    transform: scale(1.03);
}

.about-platform {
    width: 98%;
    text-align: center;
    padding: 40px 16px;
    background: #23272f;
    border-radius: 8px;
    margin-top: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.about-platform h2 {
    font-size: 1.5em;
    margin-bottom: 12px;
    color: #7ad1e6;
    letter-spacing: 0.5px;
}

.about-platform p {
    font-size: 1em;
    color: #e0e0e0;
    max-width: 800px;
    margin: 0 auto;
}

.platform-features {
    width: 98%;
    text-align: center;
    padding: 48px 16px;
    background: #23272f;
    border-radius: 8px;
    margin-top: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.platform-features h2 {
    color: #7ad1e6;
    font-size: 1.5em;
    margin-bottom: 12px;
    letter-spacing: 0.5px;
}

.feature-list {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 18px;
    margin-top: 24px;
}

.feature-item {
    width: 100%;
    max-width: 280px;
    background: #282828;
    padding: 18px 12px 16px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s, background 0.2s;
    border: 1px solid #23272f;
    position: relative;
}

.feature-item:hover {
    transform: translateY(-3px) scale(1.01);
    background: #23272f;
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    border-color: #7ad1e6;
}

.feature-item h3 {
    font-size: 1.1em;
    color: #7ad1e6;
    margin-bottom: 8px;
    letter-spacing: 0.2px;
}

.feature-item p {
    font-size: 0.98em;
    color: #e0e0e0;
}

.system-architecture {
    width: 98%;
    text-align: center;
    padding: 48px 16px;
    background: #23272f;
    border-radius: 8px;
    margin-top: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.system-architecture h2 {
    color: #7ad1e6;
    font-size: 1.5em;
    margin-bottom: 24px;
    letter-spacing: 0.5px;
}

.architecture-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 24px;
    margin-top: 24px;
}

.arch-layer {
    width: 100%;
    max-width: 400px;
    background: #282828;
    padding: 24px 16px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #23272f;
    transition: transform 0.2s;
}

.arch-layer:hover {
    transform: translateY(-2px);
    border-color: #7ad1e6;
}

.arch-layer h3 {
    font-size: 1.1em;
    color: #7ad1e6;
    margin-bottom: 16px;
}

.arch-layer ul {
    list-style: none;
    text-align: left;
}

.arch-layer li {
    font-size: 0.98em;
    color: #e0e0e0;
    margin-bottom: 8px;
    padding-left: 8px;
}

.tech-stack {
    width: 98%;
    text-align: center;
    padding: 48px 16px;
    background: #23272f;
    border-radius: 8px;
    margin-top: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.tech-stack h2 {
    color: #7ad1e6;
    font-size: 1.5em;
    margin-bottom: 24px;
    letter-spacing: 0.5px;
}

.stack-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 24px;
    margin-top: 24px;
}

.backend-stack, .frontend-stack {
    width: 100%;
    max-width: 400px;
    background: #282828;
    padding: 24px 16px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #23272f;
    transition: transform 0.2s;
}

.backend-stack:hover, .frontend-stack:hover {
    transform: translateY(-2px);
    border-color: #7ad1e6;
}

.backend-stack h3, .frontend-stack h3 {
    font-size: 1.1em;
    color: #7ad1e6;
    margin-bottom: 12px;
}

.backend-stack p, .frontend-stack p {
    font-size: 0.98em;
    color: #e0e0e0;
}

.signup-call-to-action {
    width: 98%;
    text-align: center;
    padding: 48px 16px;
    background: #23272f;
    border-radius: 8px;
    margin-top: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.signup-call-to-action h2 {
    font-size: 1.5em;
    margin-bottom: 12px;
    color: #7ad1e6;
}

.signup-call-to-action p {
    font-size: 1em;
    color: #bfc9d1;
    margin-bottom: 24px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}

.cta-buttons {
    display: flex;
    justify-content: center;
    gap: 16px;
    flex-wrap: wrap;
}

.main-footer {
    width: 100%;
    text-align: center;
    padding: 24px;
    background: #222;
    color: #bfc9d1;
    border-radius: 7px;
    margin-top: 24px;
    font-size: 0.98em;
    letter-spacing: 0.2px;
}

.developer-credit {
    font-size: 0.9em;
    color: #7ad1e6;
    margin-top: 8px;
}

/* Responsive Design */
@media screen and (max-width: 1024px) {
    .navigation-links {
        gap: 16px;
    }
    
    .architecture-grid,
    .stack-grid {
        gap: 18px;
    }
    
    .arch-layer,
    .backend-stack,
    .frontend-stack {
        max-width: 350px;
    }
}

@media screen and (max-width: 768px) {
    .main-navbar {
        padding: 12px 4%;
    }
    
    .navigation-links {
        display: none;
    }
    
    .hero-banner {
        padding: 60px 4% 40px 4%;
        margin-top: 60px;
    }
    
    .hero-content h2 {
        font-size: 1.5em;
    }
    
    .about-platform,
    .platform-features,
    .system-architecture,
    .tech-stack,
    .signup-call-to-action {
        padding: 32px 4%;
        margin-top: 16px;
    }
    
    .feature-list {
        gap: 12px;
    }
    
    .feature-item {
        max-width: 100%;
    }
    
    .cta-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .secondary-cta-button {
        margin-left: 0;
        margin-top: 8px;
    }
}

@media screen and (max-width: 480px) {
    .platform-logo h1 {
        font-size: 1.5em;
    }
    
    .hero-content h2 {
        font-size: 1.3em;
    }
    
    .hero-content p {
        font-size: 1em;
    }
    
    .about-platform h2,
    .platform-features h2,
    .system-architecture h2,
    .tech-stack h2,
    .signup-call-to-action h2 {
        font-size: 1.3em;
    }
    
    .primary-cta-button,
    .secondary-cta-button {
        padding: 10px 20px;
        font-size: 0.95em;
    }
    
    .main-footer {
        padding: 16px;
        font-size: 0.9em;
    }
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.96);}
    to { opacity: 1; transform: scale(1);}
}        
    </style>
</head>
<body>

<div class="main-page">
    <header class="main-navbar">
        <div class="platform-logo">
            <h1>RealTalk</h1>
        </div>
        <nav class="navigation-links">
            <a href="#about-section">About</a>
            <a href="#features-section">Enterprise Features</a>
            <a href="#architecture-section">Architecture</a>
            <a href="#signup-section">Get Started</a>
            <a onclick="navigateTo('login-page')" class="login-button">Enterprise Login</a>
        </nav>
    </header>

    <section class="hero-banner">
        <div class="hero-content">
            <h2>Enterprise-Grade Messaging Platform</h2>
            <p>Next Evolution of Social Communication - Production-ready enterprise messaging with advanced security and real-time capabilities</p>
            <a href="#signup-section" class="primary-cta-button">Deploy Now</a>
        </div>
    </section>

    <section id="about-section" class="about-platform">
        <h2>About RealTalk</h2>
        <p>RealTalk is a production-ready enterprise messaging solution that evolved from Social Media Platform v2. Featuring JWT authentication, Redis session management, and multi-database support for scalable, secure communication.</p>
    </section>

    <section id="features-section" class="platform-features">
        <h2>Enterprise Features</h2>
        <div class="feature-list">
            <div class="feature-item security-feature">
                <h3>ðŸ” Advanced Security System</h3>
                <p>Role-based access control, Socket.io authentication middleware, input validation & sanitization, Redis session management</p>
            </div>
            <div class="feature-item realtime-feature">
                <h3>ðŸ’¬ Real-Time Communication</h3>
                <p>WebSocket implementation with online/offline status tracking, typing indicators, and message delivery receipts</p>
            </div>
            <div class="feature-item multi-platform-feature">
                <h3>ðŸ“± Multi-Platform Support</h3>
                <p>Desktop-optimized interface, mobile-first responsive design, and Progressive Web App (PWA) ready</p>
            </div>
            <div class="feature-item social-feature">
                <h3>ðŸ‘¥ Enhanced Social Integration</h3>
                <p>Advanced friend management system with group management and global user discovery</p>
            </div>
        </div>
    </section>

    <section id="architecture-section" class="system-architecture">
        <h2>System Architecture</h2>
        <div class="architecture-grid">
            <div class="arch-layer">
                <h3>ðŸ—ï¸ Backend Microservices</h3>
                <ul>
                    <li>ðŸ›¡ï¸ Security Layer (JWT, validation, socketAuth)</li>
                    <li>ðŸ’¼ Business Logic (controllers & services)</li>
                    <li>ðŸ“Š Data Management (multi-database setup)</li>
                    <li>ðŸ”Œ Real-Time Layer (WebSocket handlers)</li>
                </ul>
            </div>
            <div class="arch-layer">
                <h3>ðŸŽ¨ Frontend Architecture</h3>
                <ul>
                    <li>ðŸ“± Multi-Device Support (Desktop & Mobile)</li>
                    <li>âš¡ Client-Side Logic (SPA navigation)</li>
                    <li>ðŸ”§ Modular CSS Architecture</li>
                    <li>ðŸŒ Socket.io Client Integration</li>
                </ul>
            </div>
        </div>
    </section>

    <section class="tech-stack">
        <h2>Technical Stack</h2>
        <div class="stack-grid">
            <div class="backend-stack">
                <h3>Backend Technologies</h3>
                <p>Node.js â€¢ Express.js â€¢ Socket.io â€¢ JWT â€¢ Redis â€¢ MongoDB â€¢ PostgreSQL â€¢ Helmet â€¢ CORS</p>
            </div>
            <div class="frontend-stack">
                <h3>Frontend Technologies</h3>
                <p>Vanilla JavaScript (ES6+) â€¢ Modular CSS â€¢ Client-side Router â€¢ Socket.io Client</p>
            </div>
        </div>
    </section>

    <section id="signup-section" class="signup-call-to-action">
        <h2>Ready for Production?</h2>
        <p>Deploy RealTalk with Docker or traditional setup. Enterprise-grade messaging at your fingertips.</p>
        <div class="cta-buttons">
            <a onclick="navigateTo('sign-up-page')" class="primary-cta-button">Quick Deployment</a>
            <a href="#documentation" class="secondary-cta-button">View Documentation</a>
        </div>
    </section>

    <footer class="main-footer">
        <p>&copy; 2024 RealTalk Enterprise - From Learning Project to Production System</p>
        <p class="developer-credit">Developed by Ravan Asgarov | Professional Software Architecture</p>
    </footer>
</div>

<div class="login-page">
    <div class="registration-container">
        <h1 class="registration-header">Log in</h1>
        <h2 class="error-message login-form-error"></h2>
        <div class="registration-form">
            <form id="login-form">
                <input type="email" id="login-email" name="login-email" class="input-field" placeholder="Email" required><br>
                <input type="password" id="login-password" name="login-password" class="input-field" placeholder="Password" required><br>
                <button type="submit" class="submit-button">Log in</button>
                <a onclick="navigateTo('forget-password-page')" class="form-link secret-section">Forget your password?</a>
                <a onclick="navigateTo('sign-up-page')" class="form-link">Or, sign up</a>
            </form>
        </div>
    </div>
</div>

<div class="sign-up-page">
    <div class="registration-container">
        <h1 class="registration-header">Sign up</h1>
        <div class="registration-form">
            <h2 class="success-message"></h2>
            <form id="sign-up-form">
                <input type="text" id="name" name="name" class="input-field" placeholder="Username" required><br>
                <input type="email" id="email" name="email" class="input-field" placeholder="Email" required><br>
                <input type="password" id="password" name="password" class="input-field" placeholder="Password" required><br>
                <input type="text" id="bio" name="bio" class="input-field" placeholder="Bio" required><br>
                <button type="submit" class="submit-button">Sign up</button>
                <a onclick="navigateTo('login-page')" class="form-link">Or, log in</a>
            </form>
        </div>
    </div>
</div>

<div class="forget-password-page">
    <div class="registration-container">
        <h1 class="registration-header">Account</h1>
        <h2 class="error-message forget-password-error"></h2>
        <div class="registration-form">
            <form id="forget-password-form">
                <input type="email" id="forget-email" name="forget-email" class="input-field" placeholder="Email" required><br>
                <button type="submit" class="submit-button">Send code</button>
                <a onclick="navigateTo('login-page')" class="form-link">Or, Log in</a>
            </form>
        </div>
    </div>
</div>

<div class="forget-code-insert-page">
    <div class="registration-container">
        <h1 class="registration-header">Insert the code</h1>
        <div class="registration-form">
            <h2 class="error-message forget-code-page-error"></h2>
            <form id="forget-code-form">
                <input type="text" id="forget-code" name="forget-code" class="input-field" placeholder="Code" required><br>
                <button type="submit" class="submit-button">Send</button>
            </form>
        </div>
    </div>
</div>

<div class="refresh-password-page">
    <div class="registration-container">
      <h1 class="registration-header">Insert the code</h1>
      <div class="registration-form">
        <h2 class="error-message refresh-password-error"></h2>
        <form id="refresh-password-form">
          <!-- Yeni ÅŸifre -->
          <input type="password" id="new-password" name="new-password" class="input-field" placeholder="New Password" required><br>
  
          <!-- Yeni ÅŸifre tekrar -->
          <input type="password" id="confirm-new-password" name="confirm-new-password" class="input-field" placeholder="Confirm New Password" required><br>
  
          <button type="submit" class="submit-button">Submit</button>
        </form>
      </div>
    </div>
</div>
  
<div class="code-insert-page">
    <div class="registration-container">
        <h1 class="registration-header">Insert the code</h1>
        <div class="registration-form">
            <h2 class="error-message insert-page-error"></h2>
            <form id="enter-code-form">
                <input type="text" id="code" name="code" class="input-field" placeholder="Code" required><br>
                <button type="submit" class="submit-button">Send</button>
            </form>
        </div>
    </div>
</div>


<div class="Landing-page">
    <div class="main-container">
        <div class="left-container">        
            <div class="top-component-top">
                <button class="add-thing-btn" onclick="toggleAddUser()">Add Friend</button>
                <button class="add-thing-btn" onclick="toggleAddGroup()">Create Group</button>
            </div>
            <div class="top-component-lower">
                <!-- Add Friend Section -->
                <div class="add-thing-container" id="add-friend-container">
                    <form id="addFriendForm">
                        <input placeholder="Enter user emal..." type="text" id="friend" name="friend">
                        <button class="add-thing-down-btn" type="submit">Add</button>
                    </form>
                </div> 
                        
                <!-- Create Group Section -->
                <div class="add-thing-container" id="add-group-container" style="display:none;">
                    <form id="addGroupForm">
                        <!-- Group Name -->
                        <input 
                            placeholder="Enter group name..." 
                            type="text" 
                            id="groupName" 
                            name="groupName"
                            required
                        >
                
                        <!-- Group Description -->
                        <textarea 
                            placeholder="Enter group description..." 
                            id="groupDescription" 
                            name="groupDescription"
                            rows="3"
                        ></textarea>
                
                        <!-- Submit Button -->
                        <button class="add-thing-down-btn" type="submit">Create</button>
                    </form>
                </div>

                <div class="profile-btn">
                    <img alt="Profile Picture" id="profileImage" onclick="navigateTo('account-container')">
                </div>
                <button class="settings-btn">
                    <i class="fas fa-cog"></i> 
                </button>
            </div>
        
            <div class="lower-component" id="lower-component"></div>
        </div>
        
        <div class="chat-container" id="chat-container">  
            <button class="toggle-btn" onclick="toggleLeftContainer()">
                <i class="fas fa-arrow-right"></i> 
            </button>            
            <!-- Upper section for user/group info -->
            <div class="chat-header" id="chat-header">
                <div class="chat-user-info">
                    <img id="chat-user-avatar" src="" alt="Profilsettingse" class="user-avatar">
                    <div class="chat-user-details">
                        <h3 id="chat-user-name">Select a chat</h3>
                        <span id="chat-user-status" class="user-status">Click on a friend or group to start chatting</span>

                        <span id="typing-indicator" class="typing-indicator" style="display: none;">
                            <span class="typing-word" aria-hidden="true">
                                <span class="typing-letter">t</span>
                                <span class="typing-letter">y</span>
                                <span class="typing-letter">p</span>
                                <span class="typing-letter">i</span>
                                <span class="typing-letter">n</span>
                                <span class="typing-letter">g</span>
                            </span>

                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn" title="More options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
            <!-- Chat messages section -->                     
            <div class="chat-box" id="chat-box"></div>
                <div class="input-container">
                    <input type="text" id="message-input" placeholder="Type your message...">
                    <button onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i> <!-- Paper plane icon for send -->
                    </button>
                </div>
        </div>
    </div>

    <!-- Friend Detail Section -->
    <div class="detail-section friend-detail" id="friend-detail">
        <div class="detail-header">
            <h2>Friend Details</h2>
            <button class="close-detail" onclick="closeDetail()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="detail-content">
            <img class="detail-avatar" id="friend-detail-avatar">
            <div class="detail-name" id="friend-detail-name">John Doe</div>
            <div class="detail-info" id="friend-detail-status">Online</div>
            
            <h3>Contact Information</h3>
            <div class="contact-info">
                <p><strong>Email:</strong> john.doe@example.com</p>
                <p><strong>Phone:</strong> +1 (555) 123-4567</p>
                <p><strong>Location:</strong> New York, USA</p>
            </div>
                        
            <h3>Shared Groups</h3>
            <ul class="member-list">
                <li class="member-item">
                    <div class="member-avatar">WD</div>
                    <div class="member-info">
                        <div class="member-name">Web Developers</div>
                        <div class="member-role">Member</div>
                    </div>
                </li>
                <li class="member-item">
                    <div class="member-avatar">GD</div>
                    <div class="member-info">
                        <div class="member-name">Game Designers</div>
                        <div class="member-role">Member</div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Group Detail Section -->
    <div class="detail-section group-detail" id="group-detail">
        <div class="detail-header">
            <h2>Group Details</h2>
            <button class="close-detail" onclick="closeDetail()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="detail-content">
            <div class="detail-avatar" id="group-detail-avatar">WD</div>
            <div class="detail-name" id="group-detail-name">Web Developers</div>
            <div class="detail-info" id="group-detail-members">12 members</div>
            
            <h3>Description</h3>
            <p>A community for web developers to share knowledge, resources, and collaborate on projects.</p>
            
            <h3>Members</h3>
            <ul class="member-list">
                <li class="member-item">
                    <div class="member-avatar">JD</div>
                    <div class="member-info">
                        <div class="member-name">John Doe</div>
                        <div class="member-role">Admin</div>
                    </div>
                </li>
                <li class="member-item">
                    <div class="member-avatar">AS</div>
                    <div class="member-info">
                        <div class="member-name">Alice Smith</div>
                        <div class="member-role">Member</div>
                    </div>
                </li>
                <li class="member-item">
                    <div class="member-avatar">BJ</div>
                    <div class="member-info">
                        <div class="member-name">Bob Johnson</div>
                        <div class="member-role">Member</div>
                    </div>
                </li>
            </ul>
                        
            <!-- Add Member Section -->
            <div class="add-member-container">
                <form id="addMemberForm">
                    <input 
                        type="text" 
                        id="newMemberEmail" 
                        name="newMemberEmail" 
                        placeholder="Enter member name..." 
                        required
                    >
                    <select id="newMemberRole" name="newMemberRole">
                        <option value="member">Member</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button type="submit">Add Member</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="account-container">
    <div class="profile-wrapper">
        <div class="profile-card">
            <div class="profile-header">
                <img id="profileImageAccount" class="profile-image" alt="Profile Image">
                <h1 id="nameAccount" class="profile-name">John Doe</h1>
            </div>

            <div class="profile-details">
                <div class="profile-detail bio-section">
                    <h3>Email</h3>
                    <p id="emailAccount" class="profile-email">johndoe@example.com</p>
                </div>
                <div class="profile-detail bio-section">
                    <h3>Bio</h3>
                    <p id="bioAccount">A passionate developer who loves coding and coffee.</p>
                </div>
            </div>

            <button class="profile-edit-button" id="editProfileButton">Edit Profile</button>
        </div>
    </div>

    <div class="profile-modal" id="editModal">
        <div class="modal-content">
            <h2>Edit Your Profile</h2>
            <label for="updateName">Name:</label>
            <input id="updateName" type="text" placeholder="Enter your name">
    
            <label for="updateBio">Bio:</label>
            <textarea id="updateBio" placeholder="Tell something about yourself"></textarea>
    
            <input type="file" id="updateImage" accept="image/*">
            <input type="hidden" id="profileImageBase64">
            <img id="profileImagePreview" src="" alt="Image Preview" class="image-preview">

            <div class="modal-buttons">
                <button id="saveChangesButton" class="save-button">Save Changes</button>
                <button id="closeModalButton" class="cancel-button">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const pages = ["main-page", "login-page", "sign-up-page", "forget-password-page", "forget-code-insert-page", "code-insert-page", "refresh-password-page", "Landing-page","account-container"];
    
    const pageHistory = [];
    let isNavigating = false;

    function navigateTo(page, updateHash = true, addToHistory = true) {
        if (isNavigating) return;
        isNavigating = true;
        
        sessionStorage.setItem('location', page);

        if (page === 'Landing-page') {
            fetchChatData(true);
            updateProfileUI(JSON.parse(sessionStorage.getItem('profileData')));
            document.getElementById("addFriendForm").addEventListener("submit", addFriend);
            document.getElementById("addGroupForm").addEventListener("submit", createGroup);
            document.getElementById("addMemberForm").addEventListener("submit", addUserToGroup);
            joinChat();
        } else if (page === 'account-container') {   
            fetchProfileDataAccount();
            document.getElementById('editProfileButton').addEventListener('click', () => {
                document.getElementById('editModal').style.display = 'flex';
            });
            document.getElementById('closeModalButton').addEventListener('click', () => {
                document.getElementById('editModal').style.display = 'none';
            });
            document.getElementById('saveChangesButton').addEventListener('click', changeProfileData);
            document.getElementById('updateImage').addEventListener('change', handleFileUpload);
        }

        pages.forEach(p => {
            const element = document.querySelector(`.${p}`);
            if (element) {
                element.style.display = (p === page) ? "flex" : "none";
            }
        });

        if (updateHash && location.hash !== `#${page}`) {
            location.hash = page;
        }

        if (addToHistory && (pageHistory.length === 0 || pageHistory[pageHistory.length - 1] !== page)) {
            pageHistory.push(page);
        }

        isNavigating = false;
    }

    window.addEventListener('popstate', function(event) {
        if (pageHistory.length > 1) {
            pageHistory.pop(); // Mevcut sayfayÄ± Ã§Ä±kar
            const previousPage = pageHistory[pageHistory.length - 1];
            navigateTo(previousPage, false, false);
        } else if (pageHistory.length === 1) {
            navigateTo(pageHistory[0], false, false);
        }
    });

    window.addEventListener('hashchange', () => {
        const hashPage = location.hash.replace('#', '');
        if (hashPage && pages.includes(hashPage)) {
            navigateTo(hashPage, false);
        }
    });

    const initialPage = location.hash ? location.hash.replace('#', '') : (sessionStorage.getItem('location') || 'main-page');
    if (pages.includes(initialPage)) {
        navigateTo(initialPage, false);
    } else {
        navigateTo('main-page', false);
    }

    window.navigateTo = navigateTo;
    window.pageHistory = pageHistory; 
});
</script>
<script>
document.getElementById("login-form").addEventListener("submit", async function(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    
    const data = {
        email: formData.get('login-email'),
        password: formData.get('login-password')
    };

    try {
        const response = await fetch("http://localhost:5000/api/v1/auth/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            credentials: 'include', // Needed to handle cookies
            body: JSON.stringify(data)
        });

        const result = await response.json();

        console.log("Login response:", result.message);

        if (result.message === 'Login successful!') {
            // Store user data if needed
            if (result.user) {
                sessionStorage.setItem('profileData', JSON.stringify(result.user));
            }
            if (result.token) {
                sessionStorage.setItem('jwt', result.token);
            }
            updateProfileUI(result.user);

            navigateTo("Landing-page");
        } else {
            document.querySelector('.login-form-error').textContent = result.message;
            document.querySelector('.login-form-error').style.display = "block";
            document.querySelector('.secret-section').style.display = "block";
        }
    } catch (error) {
        console.error("Error:", error);
        document.querySelector('.login-form-error').textContent = error;
        document.querySelector('.login-form-error').style.display = "block";
    }
});

document.getElementById("forget-password-form").addEventListener("submit", function(event) {
    event.preventDefault(); 

    const formData = new FormData(event.target);

    const data = {
        email: formData.get('forget-email')
    };

    fetch("http://localhost:5000/api/v1/auth/forgot-password/sendCode", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message == "Password recovery code sent successfully!") {
            if (data.redisKey) {
                sessionStorage.setItem('redisKey', JSON.stringify(data.redisKey));
            }            
            navigateTo("forget-code-insert-page");
        }else{
            document.querySelector('.forget-password-error').textContent = data.message;
            document.querySelector('.forget-password-error').style.display = "block";
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("An error occurred: " + error);
    });
});

document.getElementById("forget-code-form").addEventListener("submit", function(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = {
        verificationCode: formData.get('forget-code'),
        redisKey: JSON.parse(sessionStorage.getItem('redisKey')) || null
    };

    fetch("http://localhost:5000/api/v1/auth/forgot-password/verifyCode", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        credentials: 'include', // Needed to handle cookies
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message == "Code successfully verified!") {
            console.log("Data:", data);
            if (data.token) {
                sessionStorage.setItem('resetToken', JSON.stringify(data.token));
            }
            navigateTo("refresh-password-page");
        }else{
            document.querySelector('.forget-code-page-error').textContent = data.message;
            document.querySelector('.forget-code-page-error').style.display = "block";
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Error!");
    });
});

document.getElementById("refresh-password-form").addEventListener("submit", function(event) {
    event.preventDefault();

    const formData = new FormData(event.target);

    const newPassword = formData.get('new-password');
    const confirmNewPassword = formData.get('confirm-new-password');

    if (newPassword !== confirmNewPassword) {
        document.querySelector('.refresh-password-error').textContent = "New passwords do not match.";
        document.querySelector('.refresh-password-error').style.display = "block";
        return; 
    }

    const data = {
        newPassword: newPassword 
    };

    // Get the token from wherever it's stored (localStorage, sessionStorage, etc.)
    const token = sessionStorage.getItem('resetToken'); // or sessionStorage.getItem('token')

    fetch("http://localhost:5000/api/v1/auth/reset-password", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}` // Fixed header name (capital A)
        },
        credentials: 'include',
        body: JSON.stringify(data)
    })    
    .then(response => response.json())
    .then(data => {
        if (data.message === "Password reset successfully") {
            navigateTo('login-page');
        } else {
            document.querySelector('.refresh-password-error').textContent = data.error || "An error occurred.";
            document.querySelector('.refresh-password-error').style.display = "block";
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Error!");
    });
});

document.getElementById("sign-up-form").addEventListener("submit", function(event) {
    event.preventDefault();
    document.querySelector('.success-message').style.color = "green";
    document.querySelector('.success-message').textContent = 'Wait a minut....';
    document.querySelector('.success-message').style.display = "block";

    const formData = new FormData(event.target);

    const data = {
        username: formData.get('name'),
        email: formData.get('email'),
        password: formData.get('password'),
        bio: formData.get('bio'),
    };

    fetch("http://localhost:5000/api/v1/auth/register", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message == "Verification code sent successfully!") {
            if (data.redisKey) {
                sessionStorage.setItem('redisKey', JSON.stringify(data.redisKey));
            }            
            navigateTo("code-insert-page");
        }
        document.querySelector('.success-message').textContent = data.error;
        document.querySelector('.success-message').style.color = "red";
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Error!");
    });
});

document.getElementById("enter-code-form").addEventListener("submit", function(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = {
        verificationCode: formData.get('code'),
        redisKey: JSON.parse(sessionStorage.getItem('redisKey')) || null
    };

    fetch("http://localhost:5000/api/v1/auth/completeRegistration", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        credentials: 'include', // Needed to handle cookies
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        console.log("Registration response:", data);
        if (data.message == "Registration completed successfully!") {
            sessionStorage.setItem('profileData', JSON.stringify(data.user));
            updateProfileUI(data.user);
            navigateTo("Landing-page");
        }else{
            document.querySelector('.insert-page-error').textContent = data.message;
            document.querySelector('.insert-page-error').style.display = "block";
        }
    })
    .catch(error => {
        console.error("Error:", error);
    });
});

</script>
<script>
function updateAccountProfileUI(data) {
    if (!data) return;
    const profileImageAccountElement = document.getElementById('profileImageAccount');
    const nameAccountElement = document.getElementById('nameAccount');
    const emailAccountElement = document.getElementById('emailAccount');
    const bioAccountElement = document.getElementById('bioAccount');

    const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2RkZCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjOTk5Ii8+PHBhdGggZD0iTTMwIDcwIFEgMzAgNTAgNTAgNjAgUSA3MCA1MCA3MCA3MCBRIDUwIDgwIDMwIDcwIiBmaWxsPSIjOTk5Ii8+PC9zdmc+';

    const profileImageElement = document.getElementById('profileImageAccount');
    if (profileImageElement) {
        profileImageElement.onerror = function() {
            this.src = defaultAvatar;
            this.onerror = null;
        };
        profileImageElement.src = `http://localhost:5000${data.avatar}` || defaultAvatar;
    }

    nameAccountElement.textContent = data.username || 'No Name';
    emailAccountElement.textContent = data.email || 'No Email';
    bioAccountElement.textContent = data.bio || 'No Bio';

}

function fetchProfileDataAccount() {
    try {
        const savedProfileData = sessionStorage.getItem('profileData');
        if (savedProfileData) {
            const data = JSON.parse(savedProfileData);
            console.log("Profile data loaded from sessionStorage:", data);
            // Base64 placeholder for profile image
            const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2RkZCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjOTk5Ii8+PHBhdGggZD0iTTMwIDcwIFEgMzAgNTAgNTAgNjAgUSA3MCA1MCA3MCA3MCBRIDUwIDgwIDMwIDcwIiBmaWxsPSIjOTk5Ii8+PC9zdmc+';

            // Profile image with error handling
            const profileImageElement = document.getElementById('profileImageAccount');
            if (profileImageElement) {
                profileImageElement.onerror = function() {
                    this.src = defaultAvatar;
                    this.onerror = null;
                };
                profileImageElement.src = `http://localhost:5000${data.avatar}` || defaultAvatar;
            }

            // Set other profile data with fallbacks
            document.getElementById('nameAccount').innerHTML = data.username || 'Ä°simsiz KullanÄ±cÄ±';
            document.getElementById('emailAccount').textContent = data.email || 'E-posta bulunamadÄ±';
            document.getElementById('bioAccount').textContent = data.bio || 'Biografi bulunamadÄ±';

            document.getElementById('updateName').value = data.username || 'Ä°simsiz KullanÄ±cÄ±';
            document.getElementById('updateBio').value = data.bio || 'Biografi bulunamadÄ±';
        }
    } catch (error) {
        console.error('Error fetching profile data:', error);
        
        const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2ZmZjBhMCIvPjxwYXRoIGQ9Ik0zMCA1MGg0ME0zNSA3MGgzME01MCAzMHY0MCIgc3Ryb2tlPSIjOTk5IiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=';
        const profileImageElement = document.getElementById('profileImageAccount');
        if (profileImageElement) {
            profileImageElement.src = defaultAvatar;
        }
    }
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        
        reader.onloadend = function () {
            document.getElementById('profileImagePreview').src = reader.result;
            document.getElementById('profileImageBase64').value = reader.result;
        };

        reader.readAsDataURL(file);
    }
}

async function changeProfileData() {
  const name = document.getElementById('updateName').value;
  const bio = document.getElementById('updateBio').value;
  const profileImageInput = document.getElementById('updateImage'); // type="file"
  const token = sessionStorage.getItem('jwt');

  // prepare multipart/form-data
  const formData = new FormData();
  formData.append('username', name);
  formData.append('bio', bio);
  if (profileImageInput.files[0]) {
    formData.append('avatar', profileImageInput.files[0]);
  }
  console.log('Saving profile data...', { name, bio, hasImage: !!profileImageInput.files[0] });

  try {
    const response = await fetch('http://localhost:5000/api/v1/users/', {
      method: 'PATCH',
      headers: {
        "Authorization": `Bearer ${token}`,
        // DO NOT set 'Content-Type' manually â€” fetch will handle it for FormData
      },
      body: formData
    });

    const result = await response.json();

    if (result.data) {
      if (result.data) {
          sessionStorage.setItem('profileData', JSON.stringify(result.data));
      }
      updateAccountProfileUI(result.data);
    }

  } catch (error) {
    console.error('Error saving profile data:', error);
    alert('Failed to update profile. Please try again later.');
  }
}
</script>
<script>
function toggleLeftContainer() {
    const button = document.querySelector('.toggle-btn');
    button.classList.toggle('rotated');
    const leftContainer = document.querySelector(".left-container");
    leftContainer.classList.toggle("open-tggl");
    const chatContainer = document.getElementById("chat-container");
    chatContainer.classList.toggle("close-tggl");
    if (leftContainer.classList.contains("open-tggl")) {
        button.style.left = '74.4vw';
    } else {
        button.style.left = '-4px';
    }
}

function updateProfileUI(data) {
    sessionStorage.setItem('username', data.name);
    sessionStorage.setItem('email', data.email);
    sessionStorage.setItem('_id', data._id);
    const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2RkZCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjOTk5Ii8+PHBhdGggZD0iTTMwIDcwIFEgMzAgNTAgNTAgNjAgUSA3MCA1MCA3MCA3MCBRIDUwIDgwIDMwIDcwIiBmaWxsPSIjOTk5Ii8+PC9zdmc+';
    const profileImageElement = document.getElementById('profileImage');
    if (profileImageElement) {
        profileImageElement.onerror = function() {
            this.src = defaultAvatar;
            this.onerror = null;
        };
        
        profileImageElement.src = `http://localhost:5000${data.avatar}` || defaultAvatar;
    }
}

function updateAccountProfileUI(data) {
    if (!data) return;
    const profileImageAccountElement = document.getElementById('profileImageAccount');
    const nameAccountElement = document.getElementById('nameAccount');
    const emailAccountElement = document.getElementById('emailAccount');
    const bioAccountElement = document.getElementById('bioAccount');
    // Base64 placeholder for profile image
    const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2RkZCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjOTk5Ii8+PHBhdGggZD0iTTMwIDcwIFEgMzAgNTAgNTAgNjAgUSA3MCA1MCA3MCA3MCBRIDUwIDgwIDMwIDcwIiBmaWxsPSIjOTk5Ii8+PC9zdmc+';

    // Profile image with error handling
    const profileImageElement = document.getElementById('profileImageAccount');
    if (profileImageElement) {
        profileImageElement.onerror = function() {
            this.src = defaultAvatar;
            this.onerror = null;
        };
        profileImageElement.src = `http://localhost:5000${data.avatar}` || defaultAvatar;
    }

    nameAccountElement.textContent = data.username || 'No Name';
    emailAccountElement.textContent = data.email || 'No Email';
    bioAccountElement.textContent = data.bio || 'No Bio';

}

async function fetchChatData(Allow) {
    try {
        if (false) {
            const savedFriendsData = sessionStorage.getItem('chatData');
            if (savedFriendsData) {
                console.log("Friends data loaded from sessionStorage.");
                const data = JSON.parse(savedFriendsData);
                updateLeftContainer(data);
                return; 
            } else {
                fetchChatData(false);
                return;
            }
        }

        const token = sessionStorage.getItem('jwt'); // or sessionStorage.getItem('token')

        const responseFriends = await fetch(`http://localhost:5000/api/v1/friends`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                "Authorization": `Bearer ${token}`
            }
        });

        const responseGroups = await fetch(`http://localhost:5000/api/v1/groups`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                "Authorization": `Bearer ${token}`
            }
        });


        if (!responseFriends.ok && !responseGroups.ok) {
            throw new Error('Network response was not ok');
        }

        const friendsData = await responseFriends.json();
        const groupsData = await responseGroups.json();

        const data = {
            friends: friendsData.data || [],
            groups: groupsData.data || []
        };
        sessionStorage.setItem('chatData', JSON.stringify(data));
        await joinGroupsToSockets(data.groups);

        console.log('Fetched friends data:', data);
        updateLeftContainer(data);

    } catch (error) {
        console.error('Error fetching friends data:', error);
        document.getElementById('errorMessage').textContent = 'Failed to load friends data. Please try again later.';
    }
}

async function updateLeftContainer(data) {
    console.log('Updating friends list with data:', data);
    if (data.friends) {
        const user_list = document.querySelector('.lower-component');
        if (!user_list) {
            console.error('User list element not found.');
            return;
        }

        checkFriendsOnlineStatus(data.friends);
        user_list.innerHTML = ''; // Clear previous content

        let count = data.friends.length;
        for (let index = 0; index < count; index++) {
            const friend = data.friends[index];

            const activityDiv = document.createElement('div');
            activityDiv.setAttribute('_id', friend._id);
            activityDiv.className = 'user friend-selected';
            activityDiv.id = `user-${friend._id}`;

            // Create Profile Image Div
            const profileImageDiv = document.createElement('div');
            profileImageDiv.className = 'friend-profile-image';

            // Base64 encoded placeholder (gri daire ÅŸeklinde)
            const defaultProfilePlaceholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2RkZCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjOTk5Ii8+PHBhdGggZD0iTTMwIDcwIFEgMzAgNTAgNTAgNjAgUSA3MCA1MCA3MCA3MCBRIDUwIDgwIDMwIDcwIiBmaWxsPSIjOTk5Ii8+PC9zdmc+';

            profileImageDiv.style.backgroundImage = `url(${defaultProfilePlaceholder})`;

            if (friend.profileImage) {
                const img = new Image();
                // If the server returns a path starting with '/', prefix the backend origin
                const imageUrl = friend.profileImage.startsWith('http') ? friend.profileImage : `http://localhost:5000${friend.profileImage}`;
                img.onload = function() {
                    // Use backgroundImage for divs instead of src
                    profileImageDiv.style.backgroundImage = `url(${imageUrl})`;
                };
                img.onerror = function() {
                    console.log('Profil resmi yÃ¼klenemedi:', friend.profileImage);
                };
                img.src = imageUrl;
            }

            profileImageDiv.onclick = function () {
                event.stopPropagation(); // prevent handleUserClick
                openFriendDetail(friend);
            }

            // Create and set the friend's name
            const nameDiv = document.createElement('div');
            nameDiv.textContent = friend.name; // Friend's name

            nameDiv.setAttribute('_id', friend._id);
            nameDiv.className = 'friend-name friend-selected';

            const unReadCount = document.createElement('div');
            unReadCount.textContent = friend.unreadCount; 

            unReadCount.setAttribute('_id', friend._id);
            unReadCount.className = 'unread-count';

            // Create the main container
            const typingDots = document.createElement('span');
            typingDots.className = 'typing-dots';
            typingDots.style.display = 'none'; // Initially hidden
            typingDots.style.marginLeft = `auto`;

            // Create 3 dot spans
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('span');
                dot.textContent = 'â€¢';
                typingDots.appendChild(dot);
            }

            // Append the profile image and name to the user div
            activityDiv.appendChild(profileImageDiv);
            activityDiv.appendChild(nameDiv);
            if (friend.unreadCount!==0) {
                activityDiv.appendChild(unReadCount);
            }
            activityDiv.appendChild(typingDots);

            activityDiv.addEventListener('click', handleUserClick);
            unReadCount.addEventListener('click', handleUserClick);
            nameDiv.addEventListener('click', handleUserClick);

            // Append the user div to the user list
            user_list.appendChild(activityDiv);

            let chatBox = document.getElementById(`chatbox-${friend._id}`);
            if (!chatBox) {
              chatBox = document.createElement('div');
              chatBox.classList.add('chat-box');
              chatBox.style.display = 'none'; 
              chatBox.id = `chatbox-${friend._id}`;

              const container = document.getElementById('chat-container');
              if (!container) {
                console.error('Chat container bulunamadÄ±.');
                return;
              }

              container.prepend(chatBox);
            }

        }
    } else {
        console.error('No friends data found.');
    }
    if (data.groups) {
        const user_list = document.querySelector('.lower-component');
        if (!user_list) {
            console.error('User list element not found.');
            return;
        }

        let count = data.groups.length;
        for (let index = 0; index < count; index++) {
        const group = data.groups[index];
        const activityDiv = document.createElement('div');
        activityDiv.setAttribute('_id', group._id);
        activityDiv.className = 'user group-selected';
        activityDiv.id = `group-${group._id}`;

        // Create Profile Image Div
        const profileImageDiv = document.createElement('div');
        profileImageDiv.className = 'friend-profile-image';

        // Base64 encoded group placeholder
        const defaultGroupPlaceholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2Y1ZjVmNSIvPjxjaXJjbGUgY3g9IjMwIiBjeT0iMzUiIHI9IjEwIiBmaWxsPSIjZGRkIi8+PGNpcmNsZSBjeD0iNTAiIGN5PSIzMCIgcj0iOCIgZmlsbD0iI2RkZCIvPjxjaXJjbGUgY3g9IjcwIiBjeT0iMzUiIHI9IjEyIiBmaWxsPSIjZGRkIi8+PHBhdGggZD0iTTI1IDY1IEMgMjUgNTUgMzUgNTAgNTAgNTUgQyA2NSA1MCA3NSA1NSA3NSA2NSBDIDUwIDgwIDI1IDgwIDI1IDY1IiBmaWxsPSIjZGRkIi8+PC9zdmc+';
        
        profileImageDiv.style.backgroundImage = `url(${defaultGroupPlaceholder})`;

        if (group.groupImage) {
            const img = new Image();
            img.onload = function() {
                profileImageDiv.style.backgroundImage = `url(${group.groupImage})`;
            };
            img.onerror = function() {
                console.log('Grup:', group.groupImage);
            };
            img.src = group.groupImage;
        }

        profileImageDiv.onclick = function () {
            event.stopPropagation(); // prevent handleGroupClick
            openGroupDetail(group);
        }

            // Create and set the group's name
            const nameDiv = document.createElement('div');
            nameDiv.textContent = group.name; // Group's name

            nameDiv.setAttribute('_id', group._id);
            nameDiv.className = 'friend-name group-selected';

            const unReadCount = document.createElement('div');
            unReadCount.textContent = group.unreadCount; 

            unReadCount.setAttribute('_id', group._id);
            unReadCount.className = 'unread-count';

            // Create the main container
            const typingDots = document.createElement('span');
            typingDots.className = 'typing-dots';
            typingDots.style.display = 'none'; // Initially hidden
            typingDots.style.marginLeft = `auto`;

            // Create 3 dot spans
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('span');
                dot.textContent = 'â€¢';
                typingDots.appendChild(dot);
            }

            // Append the profile image and name to the user div
            activityDiv.appendChild(profileImageDiv);
            activityDiv.appendChild(nameDiv);
            if (group.unreadCount!==0) {
                activityDiv.appendChild(unReadCount);
            }
            activityDiv.appendChild(typingDots);

            activityDiv.addEventListener('click', handleGroupClick);
            nameDiv.addEventListener('click', handleGroupClick);

            // Append the user div to the user list
            user_list.appendChild(activityDiv);

            let chatBox = document.getElementById(`chatbox-${group._id}`);
            if (!chatBox) {
              chatBox = document.createElement('div');
              chatBox.classList.add('chat-box');
              chatBox.style.display = 'none'; 
              chatBox.id = `chatbox-${group._id}`;

              const container = document.getElementById('chat-container');
              if (!container) {
                console.error('Chat container bulunamadÄ±.');
                return;
              }

              container.prepend(chatBox);
            }
        }
    } else {
        console.error('No groups data found.');
    }
}
 
function addFriend(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = {
        email: formData.get('friend'),
    };

    const token = sessionStorage.getItem('jwt'); // or sessionStorage.getItem('token')

    fetch("http://localhost:5000/api/v1/friends/sendFriendRequest", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        console.log("Add friend response:", data);
        if (data.message === "Friend request sent successfully!") {
            fetchChatData(false);
        } else {
            alert("Failed to add friend");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("An error occurred: " + error.message);
    });
}

function createGroup(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = {
        name: formData.get('groupName'),
        description: formData.get('groupDescription')
    };

    const token = sessionStorage.getItem('jwt'); // or sessionStorage.getItem('token')

    fetch("http://localhost:5000/api/v1/groups", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        console.log("Create group response:", data);
        if (data.message === "Group created successfully!") {
            fetchChatData(false);
        } else {
            alert("Failed to create group");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("An error occurred: " + error.message);
    });
}

async function addUserToGroup(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const groupId = sessionStorage.getItem('recipient');
    const memberEmail = formData.get('newMemberEmail');
    const memberRole = formData.get('newMemberRole');

    console.log('Adding member to group:', groupId, memberEmail, memberRole);

    if (!groupId || !memberEmail) {
        alert("Please select a group and enter member name.");
        return;
    }

    const token = sessionStorage.getItem('jwt');

    try {
        const response = await fetch(`http://localhost:5000/api/v1/groups/${encodeURIComponent(groupId)}/members`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({
                email: memberEmail,
                role: memberRole
            })
        });

        const data = await response.json();
        console.log("Add user to group response:", data);

        if (data.message === "Member added successfully!") {
            fetchChatData(false);
            alert("Member added successfully!");
        } else {
            alert(data.message || "Failed to add member to group");
        }
    } catch (error) {
        console.error("Error:", error);
        alert("An error occurred: " + error.message);
    }
}

async function handleUserClick(event) {
    document.querySelectorAll('.chat-box').forEach((chatbox) => {
      chatbox.style.display = 'none';
    });

    console.log('Clicked element:', event.target);
    sessionStorage.setItem('clickedElementType', 'friend');

    if (!event.target.classList.contains('friend-selected')) return;

    const to = event.target.getAttribute('_id'); 
    const from = sessionStorage.getItem('_id'); 

    sessionStorage.setItem('recipient', to);

    readMyMessages( to, 'private' );

    if (!from) {
      console.error('GÃ¶nderen kullanÄ±cÄ± bulunamadÄ±.');
      return;
    }
    
    const chatData = JSON.parse(sessionStorage.getItem('chatData'));
    const friend = chatData.friends.find(f => f._id === to);
    if (friend) {
        sessionStorage.setItem('currentRecipientName', friend.name);
    }

    const container = document.getElementById('chat-container');
    if (!container) {
      console.error('Chat container bulunamadÄ±.');
      return;
    }

    let chatBox = document.getElementById(`chatbox-${to}`);
    if (!chatBox) {
      chatBox = document.createElement('div');
      chatBox.classList.add('chat-box');
      chatBox.id = `chatbox-${to}`;
      container.prepend(chatBox);
    }

    let chatHeader = document.getElementById(`chat-header`);
    if (chatHeader) {
       const userNameElement = chatHeader.querySelector('#chat-user-name');
        const userAvatarElement = chatHeader.querySelector('#chat-user-avatar');
        const userStatusElement = chatHeader.querySelector('#chat-user-status');
    
        if (userNameElement) {
            userNameElement.textContent = friend ? friend.name : 'Unknown';
        }

        if (userAvatarElement) {
            const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2RkZCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjOTk5Ii8+PHBhdGggZD0iTTMwIDcwIFEgMzAgNTAgNTAgNjAgUSA3MCA1MCA3MCA3MCBRIDUwIDgwIDMwIDcwIiBmaWxsPSIjOTk5Ii8+PC9zdmc+';
            userAvatarElement.onerror = function() {
                this.src = defaultAvatar;
                this.onerror = null;
            };
            userAvatarElement.onclick = function() {
                event.stopPropagation(); // prevent handleUserClick
                openFriendDetail(friend);
            }
            userAvatarElement.src = friend.profileImage ? `http://localhost:5000${friend.profileImage}` : defaultAvatar;
        }

        if (userStatusElement) {
            userStatusElement.textContent = friend && friend.isOnline ? 'Online' : 'Offline';
        }
        // Update other elements as needed...
    
        console.log('Chat header updated with name:', friend ? friend.name : 'Unknown');
    }

    chatBox.style.display = 'flex';
    chatBox.innerHTML = ''; 

    const loadingMessage = document.createElement('div');
    loadingMessage.textContent = 'Loading messages...';
    chatBox.appendChild(loadingMessage);

    const token = sessionStorage.getItem('jwt'); // or sessionStorage.getItem('token')

    try {
        const response = await fetch(`http://localhost:5000/api/v1/chats/${encodeURIComponent(to)}`, {
        method: 'GET',
        headers: { 
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${token}`
        }
    });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const result = await response.json();
      console.log('Server response:', result);

      chatBox.innerHTML = ''; 

      if (result.data.messages.length === 0) {
        const noMessagesDiv = document.createElement('div');
        noMessagesDiv.textContent = 'No messages yet.';
        chatBox.appendChild(noMessagesDiv);
      } else {
        let messagesData = result.data.messages;
        messagesData.forEach((message) => {
          const activityDiv = document.createElement('div');
          activityDiv.classList.add(message.sender === from ? 'my-message' : 'other-message');

          const strongElement = document.createElement('strong');
          strongElement.className = message.sender === from ? 'my-message-name' : 'other-message-name';
          strongElement.textContent = message.sender === from ? 'Me' : `${sessionStorage.getItem('currentRecipientName')}:`;

          const messageText = document.createElement('p');
          messageText.appendChild(strongElement);
          messageText.appendChild(document.createTextNode(` ${message.content}`));

          activityDiv.appendChild(messageText);
          chatBox.appendChild(activityDiv);
        });

        chatBox.scrollTop = chatBox.scrollHeight; 
      }
    } catch (error) {
      console.error('Error:', error);
      showErrorMessage('An error occurred while fetching messages.');
    }
  }

async function handleGroupClick(event) {
    document.querySelectorAll('.chat-box').forEach((chatbox) => {
      chatbox.style.display = 'none';
    });

    console.log('Clicked element:', event.target);
    sessionStorage.setItem('clickedElementType', 'group');

    const to = event.target.getAttribute('_id'); 
    const from = sessionStorage.getItem('_id'); 

    if (!from) {
      console.error('GÃ¶nderen kullanÄ±cÄ± bulunamadÄ±.');
      return;
    }

    sessionStorage.setItem('recipient', to);

    readMyMessages( to, 'group' );

    const container = document.getElementById('chat-container');
    if (!container) {
      console.error('Chat container bulunamadÄ±.');
      return;
    }

    let chatBox = document.getElementById(`chatbox-${to}`);
    if (!chatBox) {
      chatBox = document.createElement('div');
      chatBox.classList.add('chat-box');
      chatBox.id = `chatbox-${to}`;
      container.prepend(chatBox);
    }

    let chatHeader = document.getElementById(`chat-header`);
    if (chatHeader) {
         const userNameElement = chatHeader.querySelector('#chat-user-name');
          const userAvatarElement = chatHeader.querySelector('#chat-user-avatar');
          const userStatusElement = chatHeader.querySelector('#chat-user-status');
     
          const chatData = JSON.parse(sessionStorage.getItem('chatData'));
          const group = chatData.groups.find(g => g._id === to);
    
          if (userNameElement) {
                userNameElement.textContent = group ? group.name : 'Unknown Group';
          }
    
          if (userAvatarElement) {
                const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2Y1ZjVmNSIvPjxjaXJjbGUgY3g9IjMwIiBjeT0iMzUiIHI9IjEwIiBmaWxsPSIjZGRkIi8+PGNpcmNsZSBjeD0iNTAiIGN5PSIzMCIgcj0iOCIgZmlsbD0iI2RkZCIvPjxjaXJjbGUgY3g9IjcwIiBjeT0iMzUiIHI9IjEyIiBmaWxsPSIjZGRkIi8+PHBhdGggZD0iTTI1IDY1IEMgMjUgNTUgMzUgNTAgNTAgNTUgQyA2NSA1MCA3NSA1NSA3NSA2NSBDIDUwIDgwIDI1IDgwIDI1IDY1IiBmaWxsPSIjZGRkIi8+PC9zdmc+';
                userAvatarElement.onerror = function() {
                 this.src = defaultAvatar;
                 this.onerror = null;
                };
                userAvatarElement.onclick = function() {
                    event.stopPropagation(); // prevent handleGroupClick
                    openGroupDetail(group);
                }
                userAvatarElement.src = group && group.groupImage ? group.groupImage : defaultAvatar;
          }
    
          if (userStatusElement) {
                userStatusElement.textContent = 'Group Chat';
          }
          // Update other elements as needed...
     
          console.log('Chat header updated with group name:', group ? group.name : 'Unknown Group');
    }

    chatBox.style.display = 'flex';
    chatBox.innerHTML = ''; 

    const loadingMessage = document.createElement('div');
    loadingMessage.textContent = 'Loading messages...';
    chatBox.appendChild(loadingMessage);

    const token = sessionStorage.getItem('jwt'); // or sessionStorage.getItem('token')

    try {
        const response = await fetch(`http://localhost:5000/api/v1/chats/group/${encodeURIComponent(to)}`, {
        method: 'GET',
        headers: { 
            'Content-Type': 'application/json',
            "Authorization": `Bearer ${token}`
        }
    });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const result = await response.json();
      console.log('Server response:', result);

      chatBox.innerHTML = ''; 

      if (result.data.messages.length === 0) {
        const noMessagesDiv = document.createElement('div');
        noMessagesDiv.textContent = 'No messages yet.';
        chatBox.appendChild(noMessagesDiv);
      } else {
        let messagesData = result.data.messages;
        messagesData.forEach((message) => {
          const activityDiv = document.createElement('div');
          activityDiv.classList.add(message.sender._id === from ? 'my-message' : 'other-message');

          const strongElement = document.createElement('strong');
          strongElement.className = message.sender._id === from ? 'my-message-name' : 'other-message-name';
          strongElement.textContent = message.sender._id === from ? 'Me' : `${message.sender.email}:`;

          const messageText = document.createElement('p');
          messageText.appendChild(strongElement);
          messageText.appendChild(document.createTextNode(` ${message.content}`));

          activityDiv.appendChild(messageText);
          chatBox.appendChild(activityDiv);
        });

        chatBox.scrollTop = chatBox.scrollHeight; 
      }
    } catch (error) {
      console.error('Error:', error);
      showErrorMessage('An error occurred while fetching messages.');
    }
  }

async function readMyMessages(id, type) {
    try {
        const unreadElement = document.querySelector(
            `.unread-count`
        );
        if (unreadElement) {
            unreadElement.remove(); // Completely remove it from DOM
        }

        const token = sessionStorage.getItem('jwt'); // or sessionStorage.getItem('token')

        console.log('Marking messages as read for:', id, 'Type:', type);
        const response = await fetch(`http://localhost:5000/api/v1/chats/mark-read`, { 
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ id: id, type: type })
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const result = await response.json();

        console.log('Messages marked as read:', result);
        return result; 

    } catch (error) {
        console.error('Error:', error);
        showErrorMessage('An error occurred while marking messages as read.');
        return null; 
    }
}

function showErrorMessage(message) {
  const chatBox = document.getElementById('chat-box');
  const errorMessage = document.createElement('div');
  errorMessage.classList.add('error-message');
  errorMessage.textContent = message;
  chatBox.appendChild(errorMessage);
}
   
function toggleAddUser() {
        const container = document.getElementById('add-friend-container');
        document.getElementById('add-group-container').style.display = 'none';
        container.style.display = container.style.display === 'none' || container.style.display === '' ? 'block' : 'none';
        if (container.style.display === 'none') {
            document.getElementById('lower-component').style.maxHeight = '516px';
            return;
        } else {
            document.getElementById('lower-component').style.maxHeight = '450px';
            return;
        }
}

function toggleAddGroup() {
        const container = document.getElementById('add-group-container');
        document.getElementById('add-friend-container').style.display = 'none';
        container.style.display = container.style.display === 'none' || container.style.display === '' ? 'block' : 'none';
        if (container.style.display === 'none') {
            document.getElementById('lower-component').style.maxHeight = '516px';
            return;
        } else {
            document.getElementById('lower-component').style.maxHeight = '424px';
            return;
        }
}

function fetchProfileDataAccount() {
    try {
        const savedProfileData = sessionStorage.getItem('profileData');
        if (savedProfileData) {
            const data = JSON.parse(savedProfileData);
            console.log("Profile data loaded from sessionStorage:", data);
            // Base64 placeholder for profile image
            const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2RkZCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjOTk5Ii8+PHBhdGggZD0iTTMwIDcwIFEgMzAgNTAgNTAgNjAgUSA3MCA1MCA3MCA3MCBRIDUwIDgwIDMwIDcwIiBmaWxsPSIjOTk5Ii8+PC9zdmc+';

            // Profile image with error handling
            const profileImageElement = document.getElementById('profileImageAccount');
            if (profileImageElement) {
                profileImageElement.onerror = function() {
                    this.src = defaultAvatar;
                    this.onerror = null;
                };
                profileImageElement.src = `http://localhost:5000${data.avatar}` || defaultAvatar;
            }

            // Set other profile data with fallbacks
            document.getElementById('nameAccount').innerHTML = data.username || 'Ä°simsiz KullanÄ±cÄ±';
            document.getElementById('emailAccount').textContent = data.email || 'E-posta bulunamadÄ±';
            document.getElementById('bioAccount').textContent = data.bio || 'Biografi bulunamadÄ±';

            document.getElementById('updateName').value = data.username || 'Ä°simsiz KullanÄ±cÄ±';
            document.getElementById('updateBio').value = data.bio || 'Biografi bulunamadÄ±';
        }
    } catch (error) {
        console.error('Error fetching profile data:', error);
        
        // Hata durumunda da placeholder gÃ¶ster
        const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2ZmZjBhMCIvPjxwYXRoIGQ9Ik0zMCA1MGg0ME0zNSA3MGgzME01MCAzMHY0MCIgc3Ryb2tlPSIjOTk5IiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=';
        const profileImageElement = document.getElementById('profileImageAccount');
        if (profileImageElement) {
            profileImageElement.src = defaultAvatar;
        }
    }
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        
        reader.onloadend = function () {
            document.getElementById('profileImagePreview').src = reader.result;
            document.getElementById('profileImageBase64').value = reader.result;
        };

        reader.readAsDataURL(file);
    }
}

async function changeProfileData() {
  const name = document.getElementById('updateName').value;
  const bio = document.getElementById('updateBio').value;
  const profileImageInput = document.getElementById('updateImage'); // type="file"
  const token = sessionStorage.getItem('jwt');

  // prepare multipart/form-data
  const formData = new FormData();
  formData.append('username', name);
  formData.append('bio', bio);
  if (profileImageInput.files[0]) {
    formData.append('avatar', profileImageInput.files[0]);
  }
  console.log('Saving profile data...', { name, bio, hasImage: !!profileImageInput.files[0] });

  try {
    const response = await fetch('http://localhost:5000/api/v1/users/', {
      method: 'PATCH',
      headers: {
        "Authorization": `Bearer ${token}`,
        // DO NOT set 'Content-Type' manually â€” fetch will handle it for FormData
      },
      body: formData
    });

    const result = await response.json();

    if (result.data) {
      if (result.data) {
          sessionStorage.setItem('profileData', JSON.stringify(result.data));
      }
      updateAccountProfileUI(result.data);
    }

  } catch (error) {
    console.error('Error saving profile data:', error);
    alert('Failed to update profile. Please try again later.');
  }
}

function openFriendDetail(friend) {
    // Hide both detail panes first
    document.getElementById('friend-detail').style.display = 'none';
    document.getElementById('group-detail').style.display = 'none';
    
    // Get the friend detail pane
    const friendDetail = document.getElementById('friend-detail');
    
    // Update friend details
    document.getElementById('friend-detail-avatar').src = 
        friend.profileImage ? `http://localhost:5000${friend.profileImage}` : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0iI2RkZCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjOTk5Ii8+PHBhdGggZD0iTTMwIDcwIFEgMzAgNTAgNTAgNjAgUSA3MCA1MCA3MCA3MCBRIDUwIDgwIDMwIDcwIiBmaWxsPSIjOTk5Ii8+PC9zdmc+';
    document.getElementById('friend-detail-name').textContent = friend.name || 'Unknown Friend';
    
    // Set status (you might want to add status to your friend object)
    const status = friend.status || 'Online';
    document.getElementById('friend-detail-status').textContent = status;
    document.getElementById('friend-detail-status').className = `detail-info ${status.toLowerCase()}`;
    
    // Update contact information (you might want to add these fields to your friend object)
    const contactInfo = document.querySelector('.friend-detail .contact-info');
    if (contactInfo) {
        contactInfo.innerHTML = `
            <p><strong>Email:</strong> ${friend.email || 'Not available'}</p>
        `;
    }
    
    // Show the friend detail pane
    friendDetail.style.display = 'block';
}

function openGroupDetail(group) {
    // Hide both detail panes first
    document.getElementById('friend-detail').style.display = 'none';
    document.getElementById('group-detail').style.display = 'none';
    
    // Get the group detail pane
    const groupDetail = document.getElementById('group-detail');
    
    // Update group details
    document.getElementById('group-detail-avatar').textContent = 
        group.name ? group.name.split(' ').map(word => word.charAt(0)).join('').toUpperCase() : '?';
    document.getElementById('group-detail-name').textContent = group.name || 'Unknown Group';
    document.getElementById('group-detail-members').textContent = 
        `${group.memberCount || group.members ? group.members.length : 0} members`;
    
    // Update description (you might want to add description to your group object)
    const description = document.querySelector('.group-detail p');
    if (description) {
        description.textContent = group.description || 'No description available.';
    }
    
    // Update members list (you might want to add members to your group object)
    const memberList = document.querySelector('.group-detail .member-list');
    if (memberList && group.members) {
        memberList.innerHTML = group.members.map(member => `
            <li class="member-item">
                <div class="member-avatar">${member.user.username ? member.user.username.charAt(0).toUpperCase() : '?'}</div>
                <div class="member-info">
                    <div class="member-name">${member.user.username || 'Unknown Member'}</div>
                    <div class="member-role">${member.role || 'Member'}</div>
                </div>
            </li>
        `).join('');
    }
    
    // Show the group detail pane
    groupDetail.style.display = 'block';
}

function closeDetail() {
    document.getElementById('friend-detail').style.display = 'none';
    document.getElementById('group-detail').style.display = 'none';
}

function showTypingIndicator(user, chatId, chatType) {
    const currentRecipient = sessionStorage.getItem('recipient');

    const typingIndicator = document.getElementById('typing-indicator');
    const userStatusElem = document.getElementById(`chat-user-status`);

    if (chatId === currentRecipient && chatType === 'group' && user.userId !== sessionStorage.getItem('_id')) {
        typingIndicator.style.display = 'flex';
        userStatusElem.style.display = 'none';
    } else if (user.userId === currentRecipient && chatType === 'private') {
        typingIndicator.style.display = 'flex';
        userStatusElem.style.display = 'none';
    }

    const userElem = document.getElementById(chatType === 'group' ?  `group-${chatId}` : `user-${user.userId}`);
    let userTypingDotsElem = null;
    if (userElem) {
      userTypingDotsElem = userElem.querySelector('.typing-dots');
    }
    if (chatType === 'group' && user.userId !== sessionStorage.getItem('_id') && userTypingDotsElem){
        userTypingDotsElem.style.display = 'flex';
    } else if (chatType === 'private' && userTypingDotsElem){
        userTypingDotsElem.style.display = 'flex';
    }
}

function hideTypingIndicator(user, chatId, chatType) {
    const currentRecipient = sessionStorage.getItem('recipient');

    const typingIndicator = document.getElementById('typing-indicator');
    const userStatusElem = document.getElementById(`chat-user-status`);

    if (chatId === currentRecipient && chatType === 'group' && user.userId !== sessionStorage.getItem('_id')) {
        typingIndicator.style.display = 'none';
        userStatusElem.style.display = 'flex';
    } else if (user.userId === currentRecipient && chatType === 'private') {
        typingIndicator.style.display = 'none';
        userStatusElem.style.display = 'flex';
    }

    const userElem = document.getElementById(chatType === 'group' ?  `group-${chatId}` : `user-${user.userId}`);
    let userTypingDotsElem = null;
    if (userElem) {
      userTypingDotsElem = userElem.querySelector('.typing-dots');
    }
    if (chatType === 'group' && user.userId !== sessionStorage.getItem('_id') && userTypingDotsElem){
        userTypingDotsElem.style.display = 'none';
    } else if (chatType === 'private' && userTypingDotsElem){
        userTypingDotsElem.style.display = 'none';
    }
}

function updateTypingUsersList(chatId, typingUsers) {
    // If you want to show multiple users typing
    const chatBox = document.getElementById(`chatbox-${chatId}`);
    if (!chatBox) return;
    
    // Clear all existing typing indicators
    const existingIndicators = chatBox.querySelectorAll('.typing-indicator');
    existingIndicators.forEach(indicator => indicator.remove());
    
    // Add new ones
    typingUsers.forEach(user => {
        showTypingIndicator(chatId, user);
    });
}

function setupTypingDetection() {
    const messageInput = document.getElementById('message-input');
    let typingTimeout;
    
    messageInput.addEventListener('input', () => {
        const clickedElementType = sessionStorage.getItem('clickedElementType');
        const recipient = sessionStorage.getItem('recipient');
        
        if (!recipient) return;
        
        // Start typing
        if (clickedElementType === 'friend') {
            socket.emit('chat:typing_start', { 
                recipient: recipient 
            });
        } else if (clickedElementType === 'group') {
            socket.emit('chat:typing_start', { 
                chatId: recipient,
                chatType: 'group'
            });
        }
        
        // Clear previous timeout
        clearTimeout(typingTimeout);
        
        // Set timeout to stop typing after 1 second of inactivity
        typingTimeout = setTimeout(() => {
            if (clickedElementType === 'friend') {
                socket.emit('chat:typing_stop', { 
                    recipient: recipient 
                });
            } else if (clickedElementType === 'group') {
                socket.emit('chat:typing_stop', { 
                    chatId: recipient,
                    chatType: 'group'
                });
            }
        }, 1000);
    });
    
    // Also stop typing when message is sent
    const originalSendMessage = window.sendMessage;
    window.sendMessage = function() {
        const clickedElementType = sessionStorage.getItem('clickedElementType');
        const recipient = sessionStorage.getItem('recipient');
        
        // Stop typing
        if (clickedElementType === 'friend') {
            socket.emit('chat:typing_stop', { recipient: recipient });
        } else if (clickedElementType === 'group') {
            socket.emit('chat:typing_stop', { 
                chatId: recipient,
                chatType: 'group'
            });
        }
        
        // Clear timeout
        clearTimeout(typingTimeout);
        
        // Call original function
        return originalSendMessage.apply(this, arguments);
    };
}
</script>
</body>
</html>